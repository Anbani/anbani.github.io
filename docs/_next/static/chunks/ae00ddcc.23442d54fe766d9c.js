"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[740],{8840:function(e,t,n){function i(e){return null!=e&&"object"===typeof e&&!0===e["@@functional/placeholder"]}function s(e){return function t(n){return 0===arguments.length||i(n)?t:e.apply(this,arguments)}}function r(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return i(n)?t:s((function(t){return e(n,t)}));default:return i(n)&&i(r)?t:i(n)?s((function(t){return e(t,r)})):i(r)?s((function(t){return e(n,t)})):e(n,r)}}}function o(e){return function t(n,o,a){switch(arguments.length){case 0:return t;case 1:return i(n)?t:r((function(t,i){return e(n,t,i)}));case 2:return i(n)&&i(o)?t:i(n)?r((function(t,n){return e(t,o,n)})):i(o)?r((function(t,i){return e(n,t,i)})):s((function(t){return e(n,o,t)}));default:return i(n)&&i(o)&&i(a)?t:i(n)&&i(o)?r((function(t,n){return e(t,n,a)})):i(n)&&i(a)?r((function(t,n){return e(t,o,n)})):i(o)&&i(a)?r((function(t,i){return e(n,t,i)})):i(n)?s((function(t){return e(t,o,a)})):i(o)?s((function(t){return e(n,t,a)})):i(a)?s((function(t){return e(n,o,t)})):e(n,o,a)}}}function a(e,t){return Object.prototype.hasOwnProperty.call(t,e)}n.r(t),n.d(t,{RudderAnalytics:function(){return ls}});var l=s((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)}));function u(e){return"[object Object]"===Object.prototype.toString.call(e)}const c=Number.isInteger||function(e){return e<<0===e};function d(e,t){var n,i=e<0?t.length+e:e;return n=t,"[object String]"===Object.prototype.toString.call(n)?t.charAt(i):t[i]}function g(e,t,n){if(n||(n=new h),function(e){var t=typeof e;return null==e||"object"!=t&&"function"!=t}(e))return e;var i,s=function(t){var i=n.get(e);if(i)return i;for(var s in n.set(e,t),e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=g(e[s],!0,n));return t};switch(l(e)){case"Object":return s(Object.create(Object.getPrototypeOf(e)));case"Array":return s(Array(e.length));case"Date":return new Date(e.valueOf());case"RegExp":return i=e,new RegExp(i.source,i.flags?i.flags:(i.global?"g":"")+(i.ignoreCase?"i":"")+(i.multiline?"m":"")+(i.sticky?"y":"")+(i.unicode?"u":"")+(i.dotAll?"s":""));case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return e.slice();default:return e}}var h=function(){function e(){this.map={},this.length=0}return e.prototype.set=function(e,t){var n=this.hash(e),i=this.map[n];i||(this.map[n]=i=[]),i.push([e,t]),this.length+=1},e.prototype.hash=function(e){var t=[];for(var n in e)t.push(Object.prototype.toString.call(e[n]));return t.join()},e.prototype.get=function(e){if(this.length<=180)for(var t in this.map)for(var n=this.map[t],i=0;i<n.length;i+=1){if((r=n[i])[0]===e)return r[1]}else{var s=this.hash(e);if(n=this.map[s])for(i=0;i<n.length;i+=1){var r;if((r=n[i])[0]===e)return r[1]}}},e}(),p=s((function(e){return null!=e&&"function"===typeof e.clone?e.clone():g(e)}));function v(e,t){for(var n=t,i=0;i<e.length;i+=1){if(null==n)return;var s=e[i];n=c(s)?d(s,n):n[s]}return n}var f=o((function(e,t,n){var i,s={};for(i in n=n||{},t=t||{})a(i,t)&&(s[i]=a(i,n)?e(i,t[i],n[i]):t[i]);for(i in n)a(i,n)&&!a(i,s)&&(s[i]=n[i]);return s})),y=o((function e(t,n,i){return f((function(n,i,s){return u(i)&&u(s)?e(t,i,s):t(n,i,s)}),n,i)})),m=o((function(e,t,n){return y((function(t,n,i){return e(n,i)}),t,n)})),b=r(v),k=r((function(e,t){var n={};for(var i in t)e(t[i],i,t)&&(n[i]=t[i]);return n}));const E=e=>"function"===typeof e&&Boolean(e.constructor&&e.call&&e.apply),I=e=>"string"===typeof e,S=e=>null===e,T=e=>"undefined"===typeof e,A=e=>S(e)||T(e),w=e=>!T(e),C=e=>!A(e),P=e=>{switch(Object.prototype.toString.call(e)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return e instanceof Error}},D=(e,t)=>{const n=t.split(".");return b(n,e)},O=e=>!S(e)&&"[object Object]"===Object.prototype.toString.call(e),R=(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t))return p(t);const n=p(e);return t.forEach(((e,t)=>{n[t]=Array.isArray(e)||(e=>!S(e)&&(e=>"object"===typeof e)(e)&&!Array.isArray(e))(e)?$(n[t],e):e})),n},$=(e,t)=>m(R,e,t),N=e=>O(e)&&Object.keys(e).length>0,L=e=>{const t=k(w,e);return Object.keys(t).forEach((e=>{const n=t[e];O(n)&&(t[e]=L(n))})),t},M=e=>{const t=k(C,e);return Object.keys(t).forEach((e=>{const n=t[e];O(n)&&(t[e]=M(n))})),t},B=e=>{if(N(e))return M(e)},x=(e,t)=>w(t)?w(e)?!0===e:t:!0===e,U=e=>e.replace(/^\.+/,""),j=e=>{let t=e;if(!I(e)&&!A(e))try{t=JSON.stringify(e)}catch(ze){t=null}return t},_=e=>(e=>{const t=Array.from(e,(e=>String.fromCodePoint(e))).join("");return globalThis.btoa(t)})((new TextEncoder).encode(e)),H=(e,t,n,i,s)=>{const r={category:e,name:t,properties:n,options:i,callback:void 0};E(s)&&(r.callback=s),E(i)&&(r.category=e,r.name=t,r.properties=n,r.options=void 0,r.callback=i),E(n)&&(r.category=e,r.name=t,r.properties=void 0,r.options=void 0,r.callback=n),E(t)&&(r.category=e,r.name=void 0,r.properties=void 0,r.options=void 0,r.callback=t),E(e)&&(r.category=void 0,r.name=void 0,r.properties=void 0,r.options=void 0,r.callback=e),O(e)?(r.name=void 0,r.category=void 0,r.properties=e,E(t)?r.options=void 0:r.options=t):O(t)&&(r.name=void 0,r.properties=t,E(n)?r.options=void 0:r.options=n),I(e)&&!I(t)&&(r.category=void 0,r.name=e),w(r.category)||(r.category=void 0),w(r.name)||(r.name=void 0),r.properties=r.properties?p(r.properties):{},w(r.options)?r.options=p(r.options):r.options=void 0;const o=I(r.name)?r.name:r.properties.name,a=I(r.category)?r.category:r.properties.category;return r.properties=$(O(r.properties)?r.properties:{},{...o&&{name:o},...a&&{category:a}}),r},F=(e,t,n,i)=>{const s={name:e,properties:t,options:n,callback:void 0};return E(i)&&(s.callback=i),E(n)&&(s.properties=t,s.options=void 0,s.callback=n),E(t)&&(s.properties=void 0,s.options=void 0,s.callback=t),s.properties=C(s.properties)?p(s.properties):{},w(s.options)?s.options=p(s.options):s.options=void 0,s},K=(e,t,n,i)=>{const s={userId:e,traits:t,options:n,callback:void 0};return E(i)&&(s.callback=i),E(n)&&(s.userId=e,s.traits=t,s.options=void 0,s.callback=n),E(t)&&(s.userId=e,s.traits=void 0,s.options=void 0,s.callback=t),(O(e)||S(e))&&(s.userId=null,s.traits=e,E(t)?s.options=void 0:s.options=t),s.userId=j(s.userId),O(s.traits)?s.traits=p(s.traits):s.traits=void 0,w(s.options)?s.options=p(s.options):s.options=void 0,s},G=(e,t,n,i)=>{const s={to:e,from:t,options:n,callback:void 0};return E(i)&&(s.callback=i),E(n)&&(s.to=e,s.from=t,s.options=void 0,s.callback=n),E(t)?(s.to=e,s.from=void 0,s.options=void 0,s.callback=t):(O(t)||S(t))&&(s.to=e,s.from=void 0,s.options=t),w(s.to)&&(s.to=j(s.to)),w(s.from)?s.from=j(s.from):s.from=void 0,w(s.options)?s.options=p(s.options):s.options=void 0,s},Q=(e,t,n,i)=>{const s={groupId:e,traits:t,options:n,callback:void 0};return E(i)&&(s.callback=i),E(n)&&(s.groupId=e,s.traits=t,s.options=void 0,s.callback=n),E(t)&&(s.groupId=e,s.traits=void 0,s.options=void 0,s.callback=t),(O(e)||S(e))&&(s.groupId=null,s.traits=e,E(t)?s.options=void 0:s.options=t),s.groupId=j(s.groupId),O(s.traits)?s.traits=p(s.traits):s.traits=void 0,w(s.options)?s.options=p(s.options):s.options=void 0,s};let z=function(e){return e.LOADED="Page Loaded",e.UNLOADED="Page Unloaded",e}({});const V="CapabilitiesManager",q="ConfigManager",W="EventManager",J="PluginsManager",X="UserSessionManager",Z="ErrorHandler",Y="PluginEngine",ee="ReadyAPI",te="AnalyticsCore";for(var ne,ie=[],se=0;se<256;se++)ie[se]=(se+256).toString(16).substring(1);function re(){var e;(!ne||se+16>4096)&&(e=4096,ne=crypto.getRandomValues(new Uint8Array(e)),se=0);for(var t,n=0,i="";n<16;n++)t=ne[se+n],i+=6==n?ie[15&t|64]:8==n?ie[63&t|128]:ie[t],1&n&&n>1&&n<11&&(i+="-");return se+=16,i}for(var oe,ae=256,le=[];ae--;)le[ae]=(ae+256).toString(16).substring(1);const ue=()=>!A(globalThis.crypto)&&E(globalThis.crypto.getRandomValues)?re():function(){var e,t=0,n="";if(!oe||ae+16>256){for(oe=Array(t=256);t--;)oe[t]=256*Math.random()|0;t=ae=0}for(;t<16;t++)e=oe[ae+t],n+=6==t?le[15&e|64]:8==t?le[63&e|128]:le[e],1&t&&t>1&&t<11&&(n+="-");return ae++,n}(),ce=e=>e.toISOString(),de=(e,t)=>`Failed to load the script with the id "${e}" from URL "${t}".`,ge="[Circular Reference]",he=(e,t,n)=>{const i=[];return function(s,r){if(!t?.includes(s)&&(!e||!A(r))){if("object"!==typeof r||S(r))return r;for(;i.length>0&&i[i.length-1]!==this;)i.pop();return i.includes(r)?(n?.warn(((e,t)=>`${e}:: A circular reference has been detected in the object and the property "${t}" has been dropped from the output.`)("JSONStringify",s)),ge):(i.push(r),r)}}},pe=(e,t,n,i)=>{try{return JSON.stringify(e,he(t,n,i))}catch(s){return i?.warn("Failed to convert the value to a JSON string.",s),null}},ve=e=>{const t=[];return function(e,n){if((e=>"bigint"===typeof e)(n))return"[BigInt]";for(;t.length>0&&t[t.length-1]!==this;)t.pop();return t.includes(n)?ge:(t.push(n),n)}},fe=(e,t)=>{const n=Array.isArray(e)?[]:{};for(const i in e)if(Object.hasOwnProperty.call(e,i)){const s=e[i],r=t.call(e,i,s);O(r)||Array.isArray(r)?n[i]=fe(r,t):n[i]=r}return n},ye=(e,t)=>{const n=ve(),i=n.call(e,"",e);return O(e)||Array.isArray(e)?fe(e,n):i},me="[SDK DISPATCHED ERROR]",be=e=>{const{stack:t,stacktrace:n}=e,i=e["opera#sourceloc"],s=t??n??i;if(s&&"string"===typeof s)return s},ke=(e,t)=>{let n=e;return P(e)?n.message=`${t}: ${e.message}`:n=new Error(`${t}: ${pe(e)}`),n},Ee=e=>{if(P(e)){const t=be(e);if(t){const{stack:n,stacktrace:i}=e,s=e["opera#sourceloc"];switch(t){case n:e.stack=`${n}\n[SDK DISPATCHED ERROR]`;break;case i:e.stacktrace=`${i}\n[SDK DISPATCHED ERROR]`;break;default:e["opera#sourceloc"]=`${s}\n[SDK DISPATCHED ERROR]`}}}globalThis.dispatchEvent(new ErrorEvent("error",{error:e,bubbles:!0,cancelable:!0,composed:!0}))},Ie="RudderLabs JavaScript SDK",Se="3.16.1",Te="RudderJS-Initiated",Ae="preloadedEventsBuffer",we="ajs_aid",Ce="ajs_uid",Pe="ajs_event",De=18e5,Oe=(e="app")=>{globalThis.RudderStackGlobals||(globalThis.RudderStackGlobals={}),globalThis.RudderStackGlobals[e]||(globalThis.RudderStackGlobals[e]={})},Re=(e,t,n="app")=>{Oe(n),globalThis.RudderStackGlobals[n][e]=t},$e=(e,t="app")=>(Oe(t),globalThis.RudderStackGlobals[t][e]);const Ne=(e,t)=>{const n={};return e.forEach(((i,s)=>{if(s.startsWith(t)){const i=s.substring(t.length);n[i]=e.get(s)}})),n},Le=e=>{const t=$e(Ae)||[];((e=[])=>{const t="ajs_trait_",n="ajs_prop_",i=new URLSearchParams(globalThis.location.search);i.get(Pe)&&e.unshift(["track",i.get(Pe),Ne(i,n)]),i.get(Ce)&&e.unshift(["identify",i.get(Ce),Ne(i,t)]),i.get(we)&&e.unshift(["setAnonymousId",i.get(we)])})(t),t.length>0&&(e.enqueuePreloadBufferEvents(t),Re(Ae,[]))},Me=(e,t)=>{const n=e.shift();let i;if(E(t[n])){switch(n){case"page":i=H(...e);break;case"track":i=F(...e);break;case"identify":i=K(...e);break;case"alias":i=G(...e);break;case"group":i=Q(...e);break;default:t[n](...e)}i&&t[n](i)}},Be=(e,t,n,i=!0,s)=>new Promise(((r,o)=>{document.getElementById(t)&&o(new Error((e=>`A script with the id "${e}" is already loaded. Skipping the loading of this script to prevent conflicts.`)(t)));try{let a;(e=>{const t=document.getElementsByTagName("head");if(t.length>0)return void t[0]?.insertBefore(e,t[0]?.firstChild);const n=document.getElementsByTagName("script");if(n.length>0&&n[0]?.parentNode)return void n[0]?.parentNode.insertBefore(e,n[0]);const i=document.createElement("head");i.appendChild(e);const s=document.getElementsByTagName("html")[0];s?.insertBefore(i,s.firstChild)})(((e,t,n=!0,i=null,s=null,r={})=>{const o=document.createElement("script");return o.type="text/javascript",o.onload=i,o.onerror=s,o.src=e,o.id=t,o.async=n,Object.keys(r).forEach((e=>{o.setAttribute(e,r[e])})),o.setAttribute("data-loader","RS_JS_SDK"),o})(e,t,i,(()=>{globalThis.clearTimeout(a),r(t)}),(()=>{globalThis.clearTimeout(a),o(new Error(de(t,e)))}),s)),a=globalThis.setTimeout((()=>{o(new Error(((e,t,n)=>`A timeout of ${n} ms occurred while trying to load the script with id "${e}" from URL "${t}".`)(t,e,n)))}),n)}catch(a){o(ke(a,de(t,e)))}}));class xe{constructor(e,t,n=1e4){this.errorHandler=e,this.logger=t,this.timeout=n,this.onError=this.onError.bind(this)}loadJSFile(e){const{url:t,id:n,timeout:i,async:s,callback:r,extraAttributes:o}=e,a=!E(r);Be(t,n,i||this.timeout,s,o).then((e=>{a||r(e)})).catch((e=>{this.onError(e),a||r()}))}onError(e){this.errorHandler.onError(e,"ExternalSrcLoader")}}var Ue=Symbol.for("preact-signals");function je(){if(Ke>1)Ke--;else{for(var e,t=!1;void 0!==Fe;){var n=Fe;for(Fe=void 0,Ge++;void 0!==n;){var i=n.o;if(n.o=void 0,n.f&=-3,!(8&n.f)&&We(n))try{n.c()}catch(n){t||(e=n,t=!0)}n=i}}if(Ge=0,Ke--,t)throw e}}function _e(e){if(Ke>0)return e();Ke++;try{return e()}finally{je()}}var He=void 0,Fe=void 0,Ke=0,Ge=0,Qe=0;function ze(e){if(void 0!==He){var t=e.n;if(void 0===t||t.t!==He)return t={i:0,S:e,p:He.s,n:void 0,t:He,e:void 0,x:void 0,r:t},void 0!==He.s&&(He.s.n=t),He.s=t,e.n=t,32&He.f&&e.S(t),t;if(-1===t.i)return t.i=0,void 0!==t.n&&(t.n.p=t.p,void 0!==t.p&&(t.p.n=t.n),t.p=He.s,t.n=void 0,He.s.n=t,He.s=t),t}}function Ve(e){this.v=e,this.i=0,this.n=void 0,this.t=void 0}function qe(e){return new Ve(e)}function We(e){for(var t=e.s;void 0!==t;t=t.n)if(t.S.i!==t.i||!t.S.h()||t.S.i!==t.i)return!0;return!1}function Je(e){for(var t=e.s;void 0!==t;t=t.n){var n=t.S.n;if(void 0!==n&&(t.r=n),t.S.n=t,t.i=-1,void 0===t.n){e.s=t;break}}}function Xe(e){for(var t=e.s,n=void 0;void 0!==t;){var i=t.p;-1===t.i?(t.S.U(t),void 0!==i&&(i.n=t.n),void 0!==t.n&&(t.n.p=i)):n=t,t.S.n=t.r,void 0!==t.r&&(t.r=void 0),t=i}e.s=n}function Ze(e){Ve.call(this,void 0),this.x=e,this.s=void 0,this.g=Qe-1,this.f=4}function Ye(e){var t=e.u;if(e.u=void 0,"function"==typeof t){Ke++;var n=He;He=void 0;try{t()}catch(je){throw e.f&=-2,e.f|=8,et(e),je}finally{He=n,je()}}}function et(e){for(var t=e.s;void 0!==t;t=t.n)t.S.U(t);e.x=void 0,e.s=void 0,Ye(e)}function tt(e){if(He!==this)throw new Error("Out-of-order effect");Xe(this),He=e,this.f&=-2,8&this.f&&et(this),je()}function nt(e){this.x=e,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32}function it(e){var t=new nt(e);try{t.c()}catch(e){throw t.d(),e}return t.d.bind(t)}Ve.prototype.brand=Ue,Ve.prototype.h=function(){return!0},Ve.prototype.S=function(e){this.t!==e&&void 0===e.e&&(e.x=this.t,void 0!==this.t&&(this.t.e=e),this.t=e)},Ve.prototype.U=function(e){if(void 0!==this.t){var t=e.e,n=e.x;void 0!==t&&(t.x=n,e.e=void 0),void 0!==n&&(n.e=t,e.x=void 0),e===this.t&&(this.t=n)}},Ve.prototype.subscribe=function(e){var t=this;return it((function(){var n=t.value,i=He;He=void 0;try{e(n)}finally{He=i}}))},Ve.prototype.valueOf=function(){return this.value},Ve.prototype.toString=function(){return this.value+""},Ve.prototype.toJSON=function(){return this.value},Ve.prototype.peek=function(){var e=He;He=void 0;try{return this.value}finally{He=e}},Object.defineProperty(Ve.prototype,"value",{get:function(){var e=ze(this);return void 0!==e&&(e.i=this.i),this.v},set:function(e){if(e!==this.v){if(Ge>100)throw new Error("Cycle detected");this.v=e,this.i++,Qe++,Ke++;try{for(var t=this.t;void 0!==t;t=t.x)t.t.N()}finally{je()}}}}),(Ze.prototype=new Ve).h=function(){if(this.f&=-3,1&this.f)return!1;if(32==(36&this.f))return!0;if(this.f&=-5,this.g===Qe)return!0;if(this.g=Qe,this.f|=1,this.i>0&&!We(this))return this.f&=-2,!0;var e=He;try{Je(this),He=this;var t=this.x();(16&this.f||this.v!==t||0===this.i)&&(this.v=t,this.f&=-17,this.i++)}catch(e){this.v=e,this.f|=16,this.i++}return He=e,Xe(this),this.f&=-2,!0},Ze.prototype.S=function(e){if(void 0===this.t){this.f|=36;for(var t=this.s;void 0!==t;t=t.n)t.S.S(t)}Ve.prototype.S.call(this,e)},Ze.prototype.U=function(e){if(void 0!==this.t&&(Ve.prototype.U.call(this,e),void 0===this.t)){this.f&=-33;for(var t=this.s;void 0!==t;t=t.n)t.S.U(t)}},Ze.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var e=this.t;void 0!==e;e=e.x)e.t.N()}},Object.defineProperty(Ze.prototype,"value",{get:function(){if(1&this.f)throw new Error("Cycle detected");var e=ze(this);if(this.h(),void 0!==e&&(e.i=this.i),16&this.f)throw this.v;return this.v}}),nt.prototype.c=function(){var e=this.S();try{if(8&this.f)return;if(void 0===this.x)return;var t=this.x();"function"==typeof t&&(this.u=t)}finally{e()}},nt.prototype.S=function(){if(1&this.f)throw new Error("Cycle detected");this.f|=1,this.f&=-9,Ye(this),Je(this),Ke++;var e=He;return He=this,tt.bind(this,e)},nt.prototype.N=function(){2&this.f||(this.f|=2,this.o=Fe,Fe=this)},nt.prototype.d=function(){this.f|=8,1&this.f||et(this)};class st{constructor(){this.items=[]}enqueue(e){this.items.push(e)}dequeue(){return 0===this.items.length?null:this.items.shift()}isEmpty(){return 0===this.items.length}size(){return this.items.length}clear(){this.items=[]}}const rt={LOG:0,INFO:1,DEBUG:2,WARN:3,ERROR:4,NONE:5},ot="ERROR";const at=new class{constructor(e="LOG",t="",n=console){this.minLogLevel=rt[e],this.scope=t,this.logProvider=n}log(...e){this.outputLog("LOG",e)}info(...e){this.outputLog("INFO",e)}debug(...e){this.outputLog("DEBUG",e)}warn(...e){this.outputLog("WARN",e)}error(...e){this.outputLog("ERROR",e)}outputLog(e,t){this.minLogLevel<=rt[e]&&this.logProvider[e.toLowerCase()]?.(...this.formatLogData(t))}setScope(e){this.scope=e||this.scope}setMinLogLevel(e){this.minLogLevel=rt[e],T(this.minLogLevel)&&(this.minLogLevel=rt.LOG)}formatLogData(e){if(Array.isArray(e)&&e.length>0){let t="%c RS SDK";this.scope&&(t=`${t} - ${this.scope}`);t=`${t} %c ${I(e[0])?e[0].trim():""}`;const n=[t,"font-weight: bold; background: black; color: white;","font-weight: normal;"];return I(e[0])||n.push(e[0]),n.push(...e.slice(1)),n}return e}};let lt=function(e){return e.HANDLEDEXCEPTION="handledException",e.UNHANDLEDEXCEPTION="unhandledException",e.UNHANDLEDREJECTION="unhandledPromiseRejection",e}({});const ut=["localStorage","memoryStorage","cookieStorage","sessionStorage","none"],ct="cookieStorage",dt="Unable to process/parse source configuration response",gt="Failed to fetch the source config",ht=e=>`${e}:: The provided callback parameter is not a function.`,pt=(e,t,n)=>`${e} due to timeout or no connection (${t?t.type:""}) at the client side for URL: ${n}`,vt={All:!0},ft="js-integrations",yt="plugins",mt=new RegExp("^(https?:\\/\\/)(((([a-zA-Z\\d]([a-zA-Z\\d-]*[a-zA-Z\\d])*)\\.)+[a-zA-Z]{2,}|localhost|((25[0-5]|2[0-4][0-9]|[0-1]?[0-9]?[0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[0-1]?[0-9]?[0-9]?)))(\\:\\d+)?(\\/[-a-zA-Z\\d%_.~+]*)*(\\?[;&a-zA-Z\\d%_.~+=-]*)?(\\#[-a-zA-Z\\d_]*)?$"),bt="modern",kt="https://cdn.rudderlabs.com",Et=`${kt}/v3/modern/${ft}`,It=`${kt}/v3/modern/plugins`,St="https://api.rudderstack.com",Tt="v3",At={iubenda:"IubendaConsentManager",oneTrust:"OneTrustConsentManager",ketch:"KetchConsentManager",custom:"CustomConsentManager"},wt={[Tt]:"StorageEncryption",legacy:"StorageEncryptionLegacy"},Ct={xhr:"XhrQueue",beacon:"BeaconQueue"},Pt=qe(p({configUrl:St,loadIntegration:!0,sessions:{autoTrack:!0,timeout:De},sameSiteCookie:"Lax",polyfillIfRequired:!0,integrations:vt,useBeacon:!1,beaconQueueOptions:{},destinationsQueueOptions:{},queueOptions:{},lockIntegrationsVersion:!0,lockPluginsVersion:!0,uaChTrackLevel:"none",plugins:[],useGlobalIntegrationsConfigInEvents:!1,bufferDataPlaneEventsUntilReady:!1,dataPlaneEventsBufferTimeout:1e4,storage:{encryption:{version:Tt},migrate:!0,cookie:{}},sendAdblockPage:!1,sameDomainCookiesOnly:!1,secureCookie:!1,sendAdblockPageOptions:{},useServerSideCookies:!1})),Dt={userId:"",userTraits:{},anonymousId:"",groupId:"",groupTraits:{},initialReferrer:"",initialReferringDomain:"",sessionInfo:{},authToken:null},Ot={autoTrack:!0,timeout:De},Rt={userId:qe(Dt.userId),userTraits:qe(Dt.userTraits),anonymousId:qe(Dt.anonymousId),groupId:qe(Dt.groupId),groupTraits:qe(Dt.groupTraits),initialReferrer:qe(Dt.initialReferrer),initialReferringDomain:qe(Dt.initialReferringDomain),sessionInfo:qe(Dt.sessionInfo),authToken:qe(Dt.authToken)},$t={isOnline:qe(!0),storage:{isLocalStorageAvailable:qe(!1),isCookieStorageAvailable:qe(!1),isSessionStorageAvailable:qe(!1)},isBeaconAvailable:qe(!1),isLegacyDOM:qe(!1),isUaCHAvailable:qe(!1),isCryptoAvailable:qe(!1),isIE11:qe(!1),isAdBlocked:qe(!1)},Nt={isErrorReportingEnabled:qe(!1),isMetricsReportingEnabled:qe(!1),breadcrumbs:qe([])},Lt=qe(void 0),Mt={activeDataplaneUrl:qe(void 0),integrationsCDNPath:qe(Et),pluginsCDNPath:qe(It),sourceConfigUrl:qe(void 0),status:qe(void 0),initialized:qe(!1),logLevel:qe(ot),loaded:qe(!1),readyCallbacks:qe([]),writeKey:qe(void 0),dataPlaneUrl:qe(void 0)},Bt={enabled:qe(!1),initialized:qe(!1),data:qe({}),activeConsentManagerPluginName:qe(void 0),preConsent:qe({enabled:!1}),postConsent:qe({}),resolutionStrategy:qe("and"),provider:qe(void 0),metadata:qe(void 0)},xt={retries:qe(0),dropped:qe(0),sent:qe(0),queued:qe(0),triggered:qe(0),metricsServiceUrl:qe(void 0)},Ut={app:qe({name:Ie,namespace:"com.rudderlabs.javascript",version:Se,installType:"npm"}),traits:qe(null),library:qe({name:Ie,version:Se,snippetVersion:globalThis.RudderSnippetVersion}),userAgent:qe(null),device:qe(null),network:qe(null),os:qe({name:"",version:""}),locale:qe(null),screen:qe({density:0,width:0,height:0,innerWidth:0,innerHeight:0}),"ua-ch":qe(void 0),timezone:qe(void 0)},jt={configuredDestinations:qe([]),activeDestinations:qe([]),loadOnlyIntegrations:qe({}),failedDestinations:qe([]),loadIntegration:qe(!0),initializedDestinations:qe([]),clientDestinationsReady:qe(!1),integrationsConfig:qe({})},_t={toBeProcessedArray:qe([]),readyCallbacksArray:qe([])},Ht={ready:qe(!1),loadedPlugins:qe([]),failedPlugins:qe([]),pluginsToLoadFromConfig:qe([]),activePlugins:qe([]),totalPluginsToLoad:qe(0)},Ft={encryptionPluginName:qe(void 0),migrate:qe(!1),type:qe(void 0),cookie:qe(void 0),entries:qe({}),trulyAnonymousTracking:qe(!1)},Kt={isEnabledServerSideCookies:qe(!1),dataServiceUrl:qe(void 0)},Gt={eventsQueuePluginName:qe(void 0),deliveryEnabled:qe(!0)},Qt={enabled:qe(!1),pageLifecycle:{enabled:qe(!1),visitId:qe(void 0),pageLoadedTimestamp:qe(void 0)}},zt={...p({capabilities:$t,consents:Bt,context:Ut,eventBuffer:_t,lifecycle:Mt,loadOptions:Pt,metrics:xt,nativeDestinations:jt,plugins:Ht,reporting:Nt,session:Rt,source:Lt,storage:Ft,serverCookies:Kt,dataPlaneEvents:Gt,autoTrack:Qt})};function Vt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var qt,Wt={exports:{}},Jt={exports:{}};function Xt(){return qt||(qt=1,Jt.exports=function(){function e(e){return!isNaN(parseFloat(e))&&isFinite(e)}function t(e){return e.charAt(0).toUpperCase()+e.substring(1)}function n(e){return function(){return this[e]}}var i=["isConstructor","isEval","isNative","isToplevel"],s=["columnNumber","lineNumber"],r=["fileName","functionName","source"],o=["args"],a=["evalOrigin"],l=i.concat(s,r,o,a);function u(e){if(e)for(var n=0;n<l.length;n++)void 0!==e[l[n]]&&this["set"+t(l[n])](e[l[n]])}u.prototype={getArgs:function(){return this.args},setArgs:function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw new TypeError("Args must be an Array");this.args=e},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(e){if(e instanceof u)this.evalOrigin=e;else{if(!(e instanceof Object))throw new TypeError("Eval Origin must be an Object or StackFrame");this.evalOrigin=new u(e)}},toString:function(){var e=this.getFileName()||"",t=this.getLineNumber()||"",n=this.getColumnNumber()||"",i=this.getFunctionName()||"";return this.getIsEval()?e?"[eval] ("+e+":"+t+":"+n+")":"[eval]:"+t+":"+n:i?i+" ("+e+":"+t+":"+n+")":e+":"+t+":"+n}},u.fromString=function(e){var t=e.indexOf("("),n=e.lastIndexOf(")"),i=e.substring(0,t),s=e.substring(t+1,n).split(","),r=e.substring(n+1);if(0===r.indexOf("@"))var o=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(r,""),a=o[1],l=o[2],c=o[3];return new u({functionName:i,args:s||void 0,fileName:a,lineNumber:l||void 0,columnNumber:c||void 0})};for(var c=0;c<i.length;c++)u.prototype["get"+t(i[c])]=n(i[c]),u.prototype["set"+t(i[c])]=function(e){return function(t){this[e]=Boolean(t)}}(i[c]);for(var d=0;d<s.length;d++)u.prototype["get"+t(s[d])]=n(s[d]),u.prototype["set"+t(s[d])]=function(t){return function(n){if(!e(n))throw new TypeError(t+" must be a Number");this[t]=Number(n)}}(s[d]);for(var g=0;g<r.length;g++)u.prototype["get"+t(r[g])]=n(r[g]),u.prototype["set"+t(r[g])]=function(e){return function(t){this[e]=String(t)}}(r[g]);return u}()),Jt.exports}var Zt;var Yt=(Zt||(Zt=1,Wt.exports=function(e){var t=/(^|@)\S+:\d+/,n=/^\s*at .*(\S+:\d+|\(native\))/m,i=/^(eval@)?(\[native code])?$/;return{parse:function(e){if("undefined"!==typeof e.stacktrace||"undefined"!==typeof e["opera#sourceloc"])return this.parseOpera(e);if(e.stack&&e.stack.match(n))return this.parseV8OrIE(e);if(e.stack)return this.parseFFOrSafari(e);throw new Error("Cannot parse given Error object")},extractLocation:function(e){if(-1===e.indexOf(":"))return[e];var t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(e.replace(/[()]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function(t){return t.stack.split("\n").filter((function(e){return!!e.match(n)}),this).map((function(t){t.indexOf("(eval ")>-1&&(t=t.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var n=t.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),i=n.match(/ (\(.+\)$)/);n=i?n.replace(i[0],""):n;var s=this.extractLocation(i?i[1]:n),r=i&&n||void 0,o=["eval","<anonymous>"].indexOf(s[0])>-1?void 0:s[0];return new e({functionName:r,fileName:o,lineNumber:s[1],columnNumber:s[2],source:t})}),this)},parseFFOrSafari:function(t){return t.stack.split("\n").filter((function(e){return!e.match(i)}),this).map((function(t){if(t.indexOf(" > eval")>-1&&(t=t.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),-1===t.indexOf("@")&&-1===t.indexOf(":"))return new e({functionName:t});var n=/((.*".+"[^@]*)?[^@]*)(?:@)/,i=t.match(n),s=i&&i[1]?i[1]:void 0,r=this.extractLocation(t.replace(n,""));return new e({functionName:s,fileName:r[0],lineNumber:r[1],columnNumber:r[2],source:t})}),this)},parseOpera:function(e){return!e.stacktrace||e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length?this.parseOpera9(e):e.stack?this.parseOpera11(e):this.parseOpera10(e)},parseOpera9:function(t){for(var n=/Line (\d+).*script (?:in )?(\S+)/i,i=t.message.split("\n"),s=[],r=2,o=i.length;r<o;r+=2){var a=n.exec(i[r]);a&&s.push(new e({fileName:a[2],lineNumber:a[1],source:i[r]}))}return s},parseOpera10:function(t){for(var n=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,i=t.stacktrace.split("\n"),s=[],r=0,o=i.length;r<o;r+=2){var a=n.exec(i[r]);a&&s.push(new e({functionName:a[3]||void 0,fileName:a[2],lineNumber:a[1],source:i[r]}))}return s},parseOpera11:function(n){return n.stack.split("\n").filter((function(e){return!!e.match(t)&&!e.match(/^Error created at/)}),this).map((function(t){var n,i=t.split("@"),s=this.extractLocation(i.pop()),r=i.shift()||"",o=r.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0;r.match(/\(([^)]*)\)/)&&(n=r.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var a=void 0===n||"[arguments not available]"===n?void 0:n.split(",");return new e({functionName:o,args:a,fileName:s[0],lineNumber:s[1],columnNumber:s[2],source:t})}),this)}}}(Xt())),Wt.exports);const en=Vt(Yt),tn="global code",nn=e=>I(e)?e:"";function sn(e,t,n,i){return{errorClass:nn(e),message:`${n}${nn(t)}`,type:"browserjs",stacktrace:i.reduce(((e,t)=>{const n=(e=>{const t={file:e.fileName,method:(n=e.functionName,w(n)&&/^global code$/i.test(n)?tn:n),lineNumber:e.lineNumber,columnNumber:e.columnNumber};var n;return t.lineNumber&&t.lineNumber>-1&&!t.file&&!t.method&&(t.file=tn),t})(t);try{return"{}"===JSON.stringify(n)?e:e.concat(n)}catch{return e}}),[])}}const rn=(e,t)=>{try{return JSON.parse(e||"")}catch(n){t(ke(n,"Failed to parse response data"))}},on="The request failed",an=[/Failed to fetch dynamically imported module: .*/],ln=[/Failed to load the script with the id .*/,/A timeout of \d+ ms occurred while trying to load the script with id .*/],un=[new RegExp("The request failed.*"),/A script with the id .* is already loaded\./],cn={headers:{Accept:"application/json","Content-Type":"application/json;charset=UTF-8"},method:"GET"},dn=(e,t,n)=>{const i=$(cn,t||{});return n&&(i.headers=$(i.headers,{Authorization:n})),i.url=e,i},gn=(e,t=1e4,n)=>new Promise(((i,s)=>{let r;if(!0===e.sendRawData)r=e.data;else if(r=pe(e.data,!1,[],n),S(r))return void s({error:new Error("Failed to prepare data for the request."),undefined:void 0,options:e});const o=new XMLHttpRequest,a=t=>{s({error:new Error(pt(on,t,e.url)),xhr:o,options:e})};o.ontimeout=a,o.onerror=a,o.onload=()=>{o.status>=200&&o.status<400?i({response:o.responseText,xhr:o,options:e}):(t=>{var n,i,r,a,l;s({error:new Error((n=on,i=o.status,r=o.statusText,a=e.url,l=o.responseText,`${n} with status ${i} (${r}) for URL: ${a}. Response: ${l.trim()}`)),xhr:o,options:e})})()},o.open(e.method,e.url,!0),!0===e.withCredentials&&(o.withCredentials=!0),o.timeout=t,Object.keys(e.headers).forEach((t=>{e.headers[t]&&o.setRequestHeader(t,e.headers[t])}));try{o.send(r)}catch(c){s({error:ke(c,(l=on,u=e.url,`${l} for URL: ${u}`)),xhr:o,options:e})}var l,u}));const hn=new class{constructor(e){this.logger=e,this.onError=this.onError.bind(this)}init(e){this.errorHandler=e}async getData(e){const{url:t,options:n,timeout:i,isRawResponse:s}=e;try{const e=await gn(dn(t,n,this.basicAuthHeader),i,this.logger);return{data:s?e.response:rn(e.response,this.onError),details:e}}catch(r){return{data:void 0,details:r}}}getAsyncData(e){const{callback:t,url:n,options:i,timeout:s,isRawResponse:r}=e,o=!E(t);gn(dn(n,i,this.basicAuthHeader),s,this.logger).then((e=>{o||t(r?e.response:rn(e.response,this.onError),e)})).catch((e=>{o||t(void 0,e)}))}onError(e){this.errorHandler?.onError(e,"HttpClient")}setAuthHeader(e,t=!1){const n=t?e:_(`${e}:`);this.basicAuthHeader=`Basic ${n}`}resetAuthHeader(){this.basicAuthHeader=void 0}}(at),pn=["www.test-host.com","localhost","127.0.0.1","[::1]"],vn=["userId","userTraits","groupId","groupTraits","anonymousId","config","instance","eventBuffer","traits","authToken"],fn=()=>{const e=globalThis.location.hostname;return e&&pn.includes(e)?"development":"production"},yn=e=>{const t=pe(e,!1,vn);return null!==t?JSON.parse(t):{}},mn=(e,t,n,i)=>({id:`${e.value?.id??n.writeKey.value}..${t.sessionInfo.value.id??"NA"}..${i.pageLifecycle.visitId.value??"NA"}`,name:e.value?.name??"NA"}),bn=(e,t)=>({locale:e.value??"NA",userAgent:t.value??"NA",time:new Date}),kn=(e,t)=>{const n={version:"1",message_id:ue(),source:{name:"js",sdk_version:t.context.app.value.version,write_key:t.lifecycle.writeKey.value,install_type:t.context.app.value.installType},errors:e};return pe(n)};const En=new class{initialized=!1;constructor(e,t){this.httpClient=e,this.logger=t}init(){this.initialized||(this.attachErrorListeners(),this.initialized=!0)}attachErrorListeners(){globalThis.addEventListener("error",(e=>{this.onError(e,Z,void 0,lt.UNHANDLEDEXCEPTION)})),globalThis.addEventListener("unhandledrejection",(e=>{this.onError(e,Z,void 0,lt.UNHANDLEDREJECTION)}))}onError(e,t="",n="",i=lt.HANDLEDEXCEPTION){try{const s=((e,t)=>{switch(t){case lt.UNHANDLEDEXCEPTION:{const{error:t}=e;return t||e}case lt.UNHANDLEDREJECTION:return e.reason;case lt.HANDLEDEXCEPTION:default:return e}})(e,i),r=((e,t)=>{let n;var i,s;return P(e)&&I(be(e))?n=e:(t.warn((i=Z,s=pe(e),`${i}:: Ignoring a non-error: ${s}.`)),n=void 0),n})(s,this.logger);if(T(r))return;const o=n?`${n} - `:"",a=((e,t)=>{try{const n=en.parse(e);return sn(e.name,e.message,t,n)}catch{return sn(e.name,e.message,t,[])}})(r,`${t}:: ${o}`),l=be(r).includes(me);if(!l&&!(e=>{const t=e.stacktrace[0]?.file;if(!t||"string"!==typeof t)return!1;const n=t.substring(t.lastIndexOf("/")+1),i=t.split("/");return i[i.length-2]===ft||["rsa"].some((e=>n.startsWith(e)&&n.endsWith(".js")))})(a)&&i!==lt.HANDLEDEXCEPTION)return;if(zt.reporting.isErrorReportingEnabled.value&&(e=>{const t=e.message;return an.some((e=>e.test(t)))||ln.some((e=>e.test(t)))?t.includes(kt):!un.some((e=>e.test(t)))})(a)){const e=((e,t,n)=>{const{context:i,lifecycle:s,session:r,source:o,reporting:a,autoTrack:l}=n,{app:u,locale:c,userAgent:d,timezone:g,screen:h,library:v}=i;return{payloadVersion:"5",notifier:{name:"RudderStack JavaScript SDK",version:u.value.version,url:"__REPOSITORY_URL__"},events:[{exceptions:[p(e)],severity:t.severity,unhandled:t.unhandled,severityReason:t.severityReason,app:{version:u.value.version,releaseStage:fn(),type:u.value.installType},device:bn(c,d),request:{url:globalThis.location.href.split("?")[0],clientIp:"[NOT COLLECTED]"},breadcrumbs:p(a.breadcrumbs.value),context:e.message,metaData:{app:{snippetVersion:v.value.snippetVersion},device:{...h.value,timezone:g.value},...yn(n)},user:mn(o,r,s,l)}]}})(a,{severity:"error",unhandled:i!==lt.HANDLEDEXCEPTION,severityReason:{type:i}},zt);this.httpClient.getAsyncData({url:zt.metrics.metricsServiceUrl.value,options:{method:"POST",data:kn(e,zt),sendRawData:!0},isRawResponse:!0})}(i===lt.HANDLEDEXCEPTION||l)&&this.logger.error(a.message)}catch(s){this.logger.error((e=>`${e}:: Failed to handle the error.`)(Z),s)}}leaveBreadcrumb(e){try{zt.reporting.breadcrumbs.value=[...zt.reporting.breadcrumbs.value,(t=e,{type:"manual",name:t,timestamp:new Date,metaData:{}})]}catch(n){this.onError(n,`${Z}:: Failed to log breadcrumb.`)}var t}}(hn,at);const In=new class{plugins=[];byName={};cache={};config={throws:!0};constructor(e,t={}){this.config={throws:!0,...t},this.logger=e}register(e,t){if(!e.name){const t=`${Y}:: Plugin name is missing.`;if(this.config.throws)throw new Error(t);return void this.logger.error(t,e)}if(this.byName[e.name]){const t=((e,t)=>`${e}:: Plugin "${t}" already exists.`)(Y,e.name);if(this.config.throws)throw new Error(t);return void this.logger.error(t)}this.cache={},this.plugins=this.plugins.slice();let n=this.plugins.length;this.plugins.forEach(((t,i)=>{t.deps?.includes(e.name)&&(n=Math.min(n,i))})),this.plugins.splice(n,0,e),this.byName[e.name]=e,E(e.initialize)&&e.initialize(t)}unregister(e){const t=this.byName[e];if(!t){const t=`${Y}:: Plugin "${e}" not found.`;if(this.config.throws)throw new Error(t);return void this.logger.error(t)}const n=this.plugins.indexOf(t);if(-1!==n)this.cache={},delete this.byName[e],this.plugins=this.plugins.slice(),this.plugins.splice(n,1);else{const t=((e,t)=>`${e}:: Plugin "${t}" not found in plugins but found in byName. This indicates a bug in the plugin engine. Please report this issue to the development team.`)(Y,e);if(this.config.throws)throw new Error(t);this.logger.error(t)}}getPlugin(e){return this.byName[e]}getPlugins(e){const t=e??".";return this.cache[t]||(this.cache[t]=this.plugins.filter((e=>{if(e.deps?.some((e=>!this.byName[e]))){const t=e.deps.filter((e=>!this.byName[e]));return this.logger.error(((e,t,n)=>`${e}:: Plugin "${t}" could not be loaded because some of its dependencies "${n}" do not exist.`)(Y,e.name,t)),!1}return"."===t||((e,t)=>Boolean(D(e,t)))(e,t)}))),this.cache[t]}processRawPlugins(e){e(this.plugins),this.cache={}}invoke(e,t=!0,...n){let i=e;if(!i)throw new Error("Failed to invoke plugin because the extension point name is missing.");const s=i.startsWith("!"),r=this.config.throws??i.endsWith("!");if(i=i.replace(/(^!|!$)/g,""),!i)throw new Error("Failed to invoke plugin because the extension point name is invalid.");const o=i.split(".");o.pop();const a=o.join(".");return(t?this.getPlugins(i):[this.getPlugins(i)[0]]).map((e=>{const t=D(e,i);if(!E(t)||s)return t;try{return t.apply(D(e,a),n)}catch(o){if(r)throw o;this.logger.error(((e,t,n)=>`${e}:: Failed to invoke the "${t}" extension point of plugin "${n}".`)(Y,i,e.name),o)}return null}))}invokeSingle(e,...t){return this.invoke(e,!1,...t)[0]}invokeMultiple(e,...t){return this.invoke(e,!0,...t)}}(at,{throws:!0}),Sn=e=>Boolean("cloud"!==e.config.connectionMode||!0===e.config.useNativeSDKToSend||!0===e.config.useNativeSDK),Tn=e=>e.filter(Sn),An=["BeaconQueue","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ExternalAnonymousId","GoogleLinker","IubendaConsentManager","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],wn=["Bugsnag","ErrorReporting"],Cn={rudderAnalyticsRemotePlugins:{url:()=>Promise.resolve(window.RudderStackGlobals&&window.RudderStackGlobals.app&&window.RudderStackGlobals.app.pluginsCDNPath?`${window.RudderStackGlobals.app.pluginsCDNPath}/rsa-plugins.js`:"https://cdn.rudderlabs.com/v3/modern/plugins//rsa-plugins.js"),format:"esm",from:"vite"}};function Pn(e,t){const n=Object.assign(e,t);for(const i of Object.keys(n))"object"===typeof n[i]&&"object"===typeof t[i]&&(n[i]=Pn(n[i],t[i]));return n}const Dn=e=>Pn({},(globalThis.__federation_shared__||{}).default||{});function On(e,t){if(!e?.default&&t){let t=Object.create(null);return t.default=e,t.__esModule=!0,t}return e}function Rn(e,t){return async function(e){const t=Cn[e];return t.inited?t.lib:["esm","systemjs"].includes(t.format)?new Promise(((e,n)=>{("function"===typeof t.url?t.url:()=>Promise.resolve(t.url))().then((i=>{import(i).then((n=>{if(!t.inited){const e=Dn();n.init(e),t.lib=n,t.lib.init(e),t.inited=!0}e(t.lib)})).catch(n)}))})):void 0}(e).then((e=>e.get(t).then((e=>e()))))}const $n=e=>{const t={};return e.forEach((e=>{if(An.includes(e)){const n=(e=>{switch(e){case"BeaconQueue":return()=>Rn("rudderAnalyticsRemotePlugins","./BeaconQueue").then((e=>On(e,!0)));case"CustomConsentManager":return()=>Rn("rudderAnalyticsRemotePlugins","./CustomConsentManager").then((e=>On(e,!0)));case"DeviceModeDestinations":return()=>Rn("rudderAnalyticsRemotePlugins","./DeviceModeDestinations").then((e=>On(e,!0)));case"DeviceModeTransformation":return()=>Rn("rudderAnalyticsRemotePlugins","./DeviceModeTransformation").then((e=>On(e,!0)));case"ExternalAnonymousId":return()=>Rn("rudderAnalyticsRemotePlugins","./ExternalAnonymousId").then((e=>On(e,!0)));case"GoogleLinker":return()=>Rn("rudderAnalyticsRemotePlugins","./GoogleLinker").then((e=>On(e,!0)));case"KetchConsentManager":return()=>Rn("rudderAnalyticsRemotePlugins","./KetchConsentManager").then((e=>On(e,!0)));case"IubendaConsentManager":return()=>Rn("rudderAnalyticsRemotePlugins","./IubendaConsentManager").then((e=>On(e,!0)));case"NativeDestinationQueue":return()=>Rn("rudderAnalyticsRemotePlugins","./NativeDestinationQueue").then((e=>On(e,!0)));case"OneTrustConsentManager":return()=>Rn("rudderAnalyticsRemotePlugins","./OneTrustConsentManager").then((e=>On(e,!0)));case"StorageEncryption":return()=>Rn("rudderAnalyticsRemotePlugins","./StorageEncryption").then((e=>On(e,!0)));case"StorageEncryptionLegacy":return()=>Rn("rudderAnalyticsRemotePlugins","./StorageEncryptionLegacy").then((e=>On(e,!0)));case"StorageMigrator":return()=>Rn("rudderAnalyticsRemotePlugins","./StorageMigrator").then((e=>On(e,!0)));case"XhrQueue":return()=>Rn("rudderAnalyticsRemotePlugins","./XhrQueue").then((e=>On(e,!0)));default:return}})(e);n&&(t[e]=n)}})),t},Nn=e=>$n?.(e)||{},Ln={};class Mn{constructor(e,t,n){this.engine=e,this.errorHandler=t,this.logger=n,this.onError=this.onError.bind(this)}init(){zt.lifecycle.status.value="pluginsLoading",Re("pluginsCDNPath",zt.lifecycle.pluginsCDNPath.value),this.setActivePlugins(),this.registerLocalPlugins(),this.registerRemotePlugins(),this.attachEffects()}attachEffects(){it((()=>{(0===zt.plugins.activePlugins.value.length||zt.plugins.loadedPlugins.value.length+zt.plugins.failedPlugins.value.length===zt.plugins.totalPluginsToLoad.value)&&_e((()=>{zt.plugins.ready.value=!0,zt.lifecycle.status.value="pluginsReady"}))}))}getPluginsToLoadBasedOnConfig(){let e=zt.plugins.pluginsToLoadFromConfig.value;if(!e)return[];e=e.filter((e=>!wn.includes(e)||(this.logger.warn(((e,t)=>`${e}:: ${t} plugin is deprecated. Please exclude it from the load API options.`)(J,e)),!1)));const t=[{configurationStatus:()=>w(zt.dataPlaneEvents.eventsQueuePluginName.value),configurationStatusStr:"Data plane events delivery is enabled",activePluginName:zt.dataPlaneEvents.eventsQueuePluginName.value,supportedPlugins:Object.values(Ct),shouldAddMissingPlugins:!0},{configurationStatus:()=>Tn(zt.nativeDestinations.configuredDestinations.value).length>0,configurationStatusStr:"Device mode destinations are connected to the source",supportedPlugins:["DeviceModeDestinations","NativeDestinationQueue"]},{configurationStatus:()=>Tn(zt.nativeDestinations.configuredDestinations.value).some((e=>e.shouldApplyDeviceModeTransformation)),configurationStatusStr:"Device mode transformations are enabled for at least one destination",supportedPlugins:["DeviceModeTransformation"]},{configurationStatus:()=>w(zt.consents.activeConsentManagerPluginName.value),configurationStatusStr:"Consent management is enabled",activePluginName:zt.consents.activeConsentManagerPluginName.value,supportedPlugins:Object.values(At)},{configurationStatus:()=>w(zt.storage.encryptionPluginName.value),configurationStatusStr:"Storage encryption is enabled",activePluginName:zt.storage.encryptionPluginName.value,supportedPlugins:Object.values(wt)},{configurationStatus:()=>zt.storage.migrate.value,configurationStatusStr:"Storage migration is enabled",supportedPlugins:["StorageMigrator"]}];return t.forEach((t=>{t.configurationStatus()?(e=e.filter(t.activePluginName?e=>!(e!==t.activePluginName&&t.supportedPlugins.includes(e)):e=>w(e)),this.addMissingPlugins(t,false,e)):e=e.filter(void 0!==t.basePlugins?e=>!(t.basePlugins.includes(e)||t.supportedPlugins.includes(e)):e=>!t.supportedPlugins.includes(e))})),[...Object.keys({}),...e]}addMissingPlugins(e,t,n){const i=e.shouldAddMissingPlugins||t;let s;s=e.activePluginName?[...e.basePlugins||[],e.activePluginName]:[...e.supportedPlugins];const r=s.filter((e=>!n.includes(e)));r.length>0&&(i&&n.push(...r),this.logger.warn(((e,t,n,i)=>{const s=1===n.length,r=`${e}:: ${t}, but${s?` '${n[0]}' plugin was`:` ['${n.join("', '")}'] plugins were`} not configured to load.`;return i?`${r} So, ${s?"the plugin":"those plugins"} will be loaded automatically.`:`${r} Ignore if this was intentional. Otherwise, consider adding ${s?"it":"them"} to the 'plugins' load API option.`})(J,e.configurationStatusStr,r,i)))}setActivePlugins(){const e=this.getPluginsToLoadBasedOnConfig(),t=[...Object.keys(Ln),...An],n=[],i=[];e.forEach((e=>{t.includes(e)?n.push(e):i.push(e)})),i.length>0&&this.logger.warn(`${J}:: Ignoring unknown plugins: ${i.join(", ")}.`),_e((()=>{zt.plugins.totalPluginsToLoad.value=e.length,zt.plugins.activePlugins.value=n,zt.plugins.failedPlugins.value=i}))}registerLocalPlugins(){Object.values(Ln).forEach((e=>{E(e)&&zt.plugins.activePlugins.value.includes(e().name)&&this.register([e()])}))}registerRemotePlugins(){const e=(t=zt.plugins.activePlugins.value,{...Nn(t)});var t;Promise.all(Object.keys(e).map((async t=>{await e[t]().then((e=>this.register([e.default()]))).catch((e=>{zt.plugins.failedPlugins.value=[...zt.plugins.failedPlugins.value,t],this.onError(e,t)}))}))).catch((e=>{this.onError(e)}))}invokeMultiple(e,...t){try{return this.engine.invokeMultiple(e,...t)}catch(ze){return this.onError(ze,e),[]}}invokeSingle(e,...t){try{return this.engine.invokeSingle(e,...t)}catch(ze){return this.onError(ze,e),null}}register(e){e.forEach((e=>{try{this.engine.register(e,zt)}catch(ze){zt.plugins.failedPlugins.value=[...zt.plugins.failedPlugins.value,e.name],this.onError(ze)}}))}unregisterLocalPlugins(){Object.values(Ln).forEach((e=>{try{this.engine.unregister(e().name)}catch(ze){this.onError(ze)}}))}onError(e,t){this.errorHandler.onError(e,J,t)}}const Bn="cookieStorage",xn="localStorage",Un="sessionStorage",jn="memoryStorage",_n="none",Hn={userId:"rl_user_id",userTraits:"rl_trait",anonymousId:"rl_anonymous_id",groupId:"rl_group_id",groupTraits:"rl_group_trait",initialReferrer:"rl_page_init_referrer",initialReferringDomain:"rl_page_init_referring_domain",sessionInfo:"rl_session",authToken:"rl_auth_token"},Fn="clientDataInCookie",Kn="clientDataInLocalStorage",Gn="clientDataInSessionStorage",Qn=["userId","userTraits","anonymousId","groupId","groupTraits","initialReferrer","initialReferringDomain","sessionInfo","authToken"],zn={[Bn]:Fn,[xn]:Kn,[jn]:"clientDataInMemory",[Un]:Gn},Vn=(e,t)=>{try{return encodeURIComponent(e)}catch(n){return void t?.error("Failed to encode the cookie data.",n)}},qn=e=>{try{return decodeURIComponent(e)}catch(t){return}},Wn=(e,t,n,i)=>{const s={...n||{}};let r=`${Vn(e,i)}=${Vn(t,i)}`;S(t)&&(s.maxage=-1),s.maxage&&(s.expires=new Date(+new Date+s.maxage)),s.path&&(r+=`; path=${s.path}`),s.domain&&(r+=`; domain=${s.domain}`),s.expires&&(r+=`; expires=${s.expires.toUTCString()}`),s.samesite&&(r+=`; samesite=${s.samesite}`),s.secure&&(r+="; secure"),globalThis.document.cookie=r},Jn=()=>(e=>{const t={},n=e.split(/\s*;\s*/);let i;return n[0]?(n.forEach((e=>{i=e.split("=");const n=i[0]?qn(i[0]):void 0;n&&(t[n]=i[1]?qn(i[1]):void 0)})),t):t})(globalThis.document.cookie),Xn=e=>Jn()[e],Zn=function(e,t,n,i){switch(arguments.length){case 4:case 3:case 2:return Wn(e,t,n,i);case 1:return e?Xn(e):Jn();default:return Jn()}},Yn=e=>{const t="function"!==typeof globalThis.URL?(e=>{const t=document.createElement("a");return t.href=e,t.hostname})(e):new URL(e).hostname,n=t?.split(".")??[],i=n[n.length-1],s=[];if(4===n.length&&i&&i===parseInt(i,10).toString())return s;if(n.length<=1)return n[0]&&-1!==n[0].indexOf("localhost")?["localhost"]:s;for(let r=n.length-2;r>=0;r-=1)s.push(n.slice(r).join("."));return s},ei=()=>{const e=`.${(e=>{const t=Yn(e);for(let n=0;n<t.length;n+=1){const e=t[n],i="__tld__",s={domain:`${-1!==e.indexOf("localhost")?"":"."}${e}`};if(Zn(i,1,s),Zn(i))return Zn(i,null,s),e}return""})(globalThis.location.href)}`;return{maxage:31536e6,path:"/",domain:e&&"."!==e?e:void 0,samesite:"Lax",enabled:!0}};const ti=new class{isEnabled=!0;length=0;data={};constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=$(this.options,e??{}),this.isEnabled=Boolean(this.options.enabled),this.options}setItem(e,t){return this.data[e]=t,this.length=Object.keys(this.data).length,t}getItem(e){return e in this.data?this.data[e]:null}removeItem(e){return e in this.data&&delete this.data[e],this.length=Object.keys(this.data).length,null}clear(){this.data={},this.length=0}key(e){return this.keys()[e]??null}keys(){return Object.keys(this.data)}}(at);var ni,ii={exports:{}};var si=(ni||(ni=1,ii.exports=function(){function e(e){return e=JSON.stringify(e),!!/^\{[\s\S]*\}$/.test(e)}function t(e){return void 0===e||"function"===typeof e?e+"":JSON.stringify(e)}function n(e){if("string"===typeof e)try{return JSON.parse(e)}catch(ze){return e}}function i(e){return"[object Function]"==={}.toString.call(e)}function s(e){return"[object Array]"===Object.prototype.toString.call(e)}function r(e){var t="_Is_Incognit",n="yes";try{e||(e=window.localStorage),e.setItem(t,n),e.removeItem(t)}catch(ze){var i={_data:{},setItem:function(e,t){return i._data[e]=String(t)},getItem:function(e){return i._data.hasOwnProperty(e)?i._data[e]:void 0},removeItem:function(e){return delete i._data[e]},clear:function(){return i._data={}}};e=i}finally{e.getItem(t)===n&&e.removeItem(t)}return e}var o=r();function a(){if(!(this instanceof a))return new a}a.prototype={set:function(n,i){if(n&&!e(n))o.setItem(n,t(i));else if(e(n))for(var s in n)this.set(s,n[s]);return this},get:function(e){if(void 0===e){var t={};return this.forEach((function(e,n){return t[e]=n})),t}if("?"===e.charAt(0))return this.has(e.substr(1));var i=arguments;if(i.length>1){for(var s={},r=0,a=i.length;r<a;r++){var l=n(o.getItem(i[r]));this.has(i[r])&&(s[i[r]]=l)}return s}return n(o.getItem(e))},clear:function(){return o.clear(),this},remove:function(e){var t=this.get(e);return o.removeItem(e),t},has:function(e){return{}.hasOwnProperty.call(this.get(),e)},keys:function(){var e=[];return this.forEach((function(t){e.push(t)})),e},forEach:function(e){for(var t=0,n=o.length;t<n;t++){var i=o.key(t);e(i,this.get(i))}return this},search:function(e){for(var t=this.keys(),n={},i=0,s=t.length;i<s;i++)t[i].indexOf(e)>-1&&(n[t[i]]=this.get(t[i]));return n},len:function(){return o.length}};var l=null;function u(t,n){var r=arguments,o=null;if(l||(l=a()),0===r.length)return l.get();if(1===r.length){if("string"===typeof t)return l.get(t);if(e(t))return l.set(t)}if(2===r.length&&"string"===typeof t){if(!n)return l.remove(t);if(n&&"string"===typeof n)return l.set(t,n);n&&i(n)&&(o=null,o=n(t,l.get(t)),u.set(t,o))}if(2===r.length&&s(t)&&i(n))for(var c=0,d=t.length;c<d;c++)o=n(t[c],l.get(t[c])),u.set(t[c],o);return u}for(var c in a.prototype)u[c]=a.prototype[c];return u}()),ii.exports);const ri=Vt(si),oi=()=>!A(globalThis.navigator.userAgentData),ai={URL:()=>!E(globalThis.URL)||!E(globalThis.URLSearchParams),Promise:()=>!E(globalThis.Promise),"Number.isNaN":()=>!E(globalThis.Number.isNaN),"Number.isInteger":()=>!E(globalThis.Number.isInteger),"Array.from":()=>!E(globalThis.Array.from),"Array.prototype.find":()=>!E(globalThis.Array.prototype.find),"Array.prototype.includes":()=>!E(globalThis.Array.prototype.includes),"String.prototype.endsWith":()=>!E(globalThis.String.prototype.endsWith),"String.prototype.startsWith":()=>!E(globalThis.String.prototype.startsWith),"String.prototype.includes":()=>!E(globalThis.String.prototype.includes),"String.prototype.replaceAll":()=>!E(globalThis.String.prototype.replaceAll),"String.fromCodePoint":()=>!E(globalThis.String.fromCodePoint),"Object.entries":()=>!E(globalThis.Object.entries),"Object.values":()=>!E(globalThis.Object.values),"Object.assign":()=>!E(globalThis.Object.assign),"Object.fromEntries":()=>!E(globalThis.Object.fromEntries),"Element.prototype.dataset":()=>!(()=>{const e=globalThis.document.createElement("div");return e.setAttribute("data-a-b","c"),!!e.dataset&&"c"===e.dataset.aB})(),TextEncoder:()=>!E(globalThis.TextEncoder)||!E(globalThis.TextDecoder),requestAnimationFrame:()=>!E(globalThis.requestAnimationFrame)||!E(globalThis.cancelAnimationFrame),CustomEvent:()=>!E(globalThis.CustomEvent),"navigator.sendBeacon":()=>!E(globalThis.navigator.sendBeacon),ArrayBuffer:()=>!E(globalThis.Uint8Array),Set:()=>!E(globalThis.Set),atob:()=>!E(globalThis.atob)},li=()=>{let e={density:0,width:0,height:0,innerWidth:0,innerHeight:0};return e={width:globalThis.screen.width,height:globalThis.screen.height,density:globalThis.devicePixelRatio,innerWidth:globalThis.innerWidth,innerHeight:globalThis.innerHeight},e},ui=e=>{const t=["QuotaExceededError","NS_ERROR_DOM_QUOTA_REACHED"].includes(e.name)||[22,1014].includes(e.code);return e instanceof DOMException&&t},ci=(e=xn,t,n)=>{let i,s;const r=`${V}:: The "${e}" storage type is `;let o,a="unavailable",l=!0;try{switch(e){case jn:return!0;case Bn:i=t,s="test_rudder_cookie";break;case xn:i=t??globalThis.localStorage,s="test_rudder_ls";break;case Un:i=t??globalThis.sessionStorage,s="test_rudder_ss";break;default:return!1}if(i&&(i.setItem(s,"true"),i.getItem(s)))return i.removeItem(s),!0;l=!1}catch(u){l=!1,o=u,ui(u)&&(a="full")}return l||n?.warn(`${r}${a}.`,o),!1};const di=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=$(this.options,e??{}),this.isSupportAvailable=ci(xn),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){ri.set(e,t),this.length=ri.len()}getItem(e){const t=ri.get(e);return T(t)?null:t}removeItem(e){ri.remove(e),this.length=ri.len()}clear(){ri.clear(),this.length=0}key(e){return this.keys()[e]??null}keys(){return ri.keys()}}(at);const gi=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=$(this.options,e??{}),this.isSupportAvailable=ci(Un),this.isSupportAvailable&&(this.store=globalThis.sessionStorage),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){this.store&&(this.store.setItem(e,t),this.length=this.store.length)}getItem(e){if(!this.store)return null;const t=this.store.getItem(e);return T(t)?null:t}removeItem(e){this.store&&(this.store.removeItem(e),this.length=this.store.length)}clear(){this.store?.clear(),this.length=0}key(e){return this.store?.key(e)??null}keys(){const e=[];if(!this.store)return e;for(let t=0;t<this.store.length;t+=1){const n=this.store.key(t);null!==n&&e.push(n)}return e}}(at);const hi=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.logger=e}configure(e){return this.options||(this.options=ei()),this.options=$(this.options,e??{}),this.options.sameDomainCookiesOnly&&delete this.options.domain,this.isSupportAvailable=ci(Bn,this),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){return Zn(e,t,this.options,this.logger),this.length=Object.keys(Zn()).length,!0}getItem(e){const t=Zn(e);return T(t)?null:t}removeItem(e){const t=this.setItem(e,null);return this.length=Object.keys(Zn()).length,t}clear(){}key(e){return this.keys()[e]??null}keys(){return Object.keys(Zn())}}(at),pi=e=>{switch(e){case xn:return di;case Un:return gi;case jn:return ti;case Bn:return hi;default:return ti}},vi=(e={},t={},n={},i={})=>{var s;(e=>{const t=hi.configure(e);zt.storage.cookie.value={maxage:t.maxage,path:t.path,domain:t.domain,samesite:t.samesite,expires:t.expires,secure:t.secure}})(e),s=t,di.configure(s),(e=>{ti.configure(e)})(n),(e=>{gi.configure(e)})(i)};class fi{constructor(e,t,n){this.id=e.id,this.name=e.name,this.isEncrypted=e.isEncrypted??!1,this.validKeys=e.validKeys??{},this.engine=t,this.noKeyValidation=0===Object.keys(this.validKeys).length,this.noCompoundKey=e.noCompoundKey,this.originalEngine=this.engine,this.errorHandler=e.errorHandler,this.logger=e.logger,this.pluginsManager=n}createValidKey(e){const{name:t,id:n,validKeys:i,noKeyValidation:s,noCompoundKey:r}=this;if(s)return r?e:[t,n,e].join(".");let o;return Object.values(i).forEach((i=>{i===e&&(o=r?e:[t,n,e].join("."))})),o}swapQueueStoreToInMemoryEngine(){const{name:e,id:t,validKeys:n,noCompoundKey:i}=this,s=pi(jn);Object.keys(n).forEach((r=>{const o=this.get(n[r]),a=i?r:[e,t,r].join(".");s.setItem(a,o),this.remove(r)})),this.engine=s}set(e,t){const n=this.createValidKey(e);if(n)try{this.engine.setItem(n,this.encrypt(pe(t,!1,[],this.logger)))}catch(i){ui(i)?(this.logger.warn(`${`Store ${this.id}`}:: The storage is either full or unavailable, so the data will not be persisted. Switching to in-memory storage.`),this.swapQueueStoreToInMemoryEngine(),this.set(e,t)):this.onError(ke(i,(e=>`Failed to save the value for "${e}" to storage`)(e)))}}get(e){const t=this.createValidKey(e);let n;try{return t?(n=this.decrypt(this.engine.getItem(t)),A(n)?null:JSON.parse(n)):null}catch(i){return this.onError(new Error(`${(e=>`Failed to retrieve or parse data for "${e}" from storage`)(e)}: ${i.message}`)),I(n)&&n.startsWith("RudderEncrypt:")&&this.logger.warn((e=>`The cookie data for ${e} seems to be encrypted using SDK versions < v3. The data is dropped. This can potentially stem from using SDK versions < v3 on other sites or web pages that can share cookies with this webpage. We recommend using the same SDK (v3) version everywhere or avoid disabling the storage data migration.`)(e)),null}}remove(e){const t=this.createValidKey(e);t&&this.engine.removeItem(t)}getOriginalEngine(){return this.originalEngine}decrypt(e){return A(e)?null:this.crypto(e,"decrypt")}encrypt(e){return this.crypto(e,"encrypt")}crypto(e,t){const n=!this.isEncrypted||!e||"string"!==typeof e||""===(e=>e.replace(/^\s+|\s+$/gm,""))(e);if(n)return e;const i=`storage.${t}`,s=this.pluginsManager?this.pluginsManager.invokeSingle(i,e):e;return"undefined"===typeof s?e:s??""}onError(e){this.errorHandler.onError(e,`Store ${this.id}`)}}class yi{stores={};isInitialized=!1;constructor(e,t,n){this.errorHandler=t,this.logger=n,this.pluginsManager=e}init(){if(this.isInitialized)return;const e=zt.loadOptions.value,t={cookieStorageOptions:{samesite:e.sameSiteCookie,secure:e.secureCookie,domain:e.setCookieDomain,sameDomainCookiesOnly:e.sameDomainCookiesOnly},localStorageOptions:{},inMemoryStorageOptions:{},sessionStorageOptions:{}};vi(L($(t.cookieStorageOptions??{},zt.storage.cookie?.value??{})),L(t.localStorageOptions),L(t.inMemoryStorageOptions),L(t.sessionStorageOptions)),this.initClientDataStores(),this.isInitialized=!0}initClientDataStores(){this.initializeStorageState();[jn,xn,Bn,Un].forEach((e=>{pi(e)?.isEnabled&&this.setStore({id:zn[e],name:zn[e],isEncrypted:!0,noCompoundKey:!0,type:e,errorHandler:this.errorHandler,logger:this.logger})}))}initializeStorageState(){let e=zt.storage.type.value,t=zt.loadOptions.value.storage?.entries;const n=zt.consents.postConsent.value.storage;(w(n?.type)||w(n?.entries))&&(e=n?.type,t=n?.entries);let i=!0,s={};Qn.forEach((n=>{const r=n,o=t?.[n]?.type,a=((e,t)=>{let n;if(e.consents.preConsent.value.enabled)switch(e.consents.preConsent.value.storage?.strategy){case"none":n=_n;break;case"session":"sessionInfo"!==t&&(n=_n);break;case"anonymousId":"anonymousId"!==t&&(n=_n)}return n})(zt,n),l=a??o??e??ct,u=this.getResolvedStorageTypeForEntry(l,n);u!==_n&&(i=!1),s={...s,[n]:{type:u,key:Hn[r]}}})),_e((()=>{zt.storage.type.value=e,zt.storage.entries.value=s,zt.storage.trulyAnonymousTracking.value=i}))}getResolvedStorageTypeForEntry(e,t){let n=e;switch(e){case xn:pi(xn)?.isEnabled||(n=jn);break;case Un:pi(Un)?.isEnabled||(n=jn);break;case jn:case _n:break;default:n=pi(Bn)?.isEnabled?Bn:pi(xn)?.isEnabled?xn:pi(Un)?.isEnabled?Un:jn}return n!==e&&this.logger.warn(((e,t,n,i)=>`${e}:: The storage type "${n}" is not available for entry "${t}". The SDK will initialize the entry with "${i}" storage type instead.`)("StoreManager",t,e,n)),n}setStore(e){const t=pi(e.type);return this.stores[e.id]=new fi(e,t,this.pluginsManager),this.stores[e.id]}getStore(e){return this.stores[e]}}const mi=e=>{const t=new URL(e),{host:n,protocol:i}=t,s=n.split(".");let r;return r=s.length>2?`${s[s.length-2]}.${s[s.length-1]}`:n,{topDomain:r,protocol:i}},bi=(e,t)=>`${t?window.location.origin:(e=>{const{topDomain:t,protocol:n}=mi(e);return`${n}//${t}`})(window.location.href)}/${e.startsWith("/")?e.substring(1):e}`,ki=e=>e?.endsWith("/")?ki(e.substring(0,e.length-1)):e,Ei=e=>{try{return new URL(e).host}catch(t){return null}},Ii=e=>Ei(e)??"",Si=e=>{const t={};try{const n=new URL(e),i="utm_";n.searchParams.forEach(((e,n)=>{if(n.startsWith(i)){let s=n.substring(i.length);"campaign"===s&&(s="name"),t[s]=e}}))}catch(n){}return t},Ti=e=>{if(!I(e))return!1;try{return E(globalThis.URL)&&new URL(e),mt.test(e)}catch(ze){return!1}},Ai="none",wi="immediate",Ci=e=>N(e)||Array.isArray(e),Pi=(e,t)=>{let{provider:n}=e;const i=n?At[n]:void 0;var s;return n&&!i&&(t.error((s=At,`${q}:: The consent manager "${n}" is not supported. Please choose one of the following supported consent managers: "${Object.keys(s)}".`)),n=void 0),{provider:n,consentManagerPluginName:i}},Di=(e,t)=>{let n,i,s=[],r=[],o=!1,a=!0===e?.enabled;N(e)&&a&&(({provider:i,consentManagerPluginName:n}=Pi(e,t)),Ci(e.allowedConsentIds)&&(s=e.allowedConsentIds,o=!0),Ci(e.deniedConsentIds)&&(r=e.deniedConsentIds,o=!0));const l={allowedConsentIds:s,deniedConsentIds:r};return a=a&&Boolean(n),{provider:i,consentManagerPluginName:n,initialized:o,enabled:a,consentsData:l}},Oi=e=>{zt.reporting.isErrorReportingEnabled.value=!0===e.source.config?.statsCollection?.errors?.enabled&&!window.chrome?.runtime?.id,zt.reporting.isMetricsReportingEnabled.value=(e=>!0===e?.statsCollection?.metrics?.enabled)(e.source.config)},Ri=e=>{const{useServerSideCookies:t,dataServiceEndpoint:n,storage:i,setCookieDomain:s,sameDomainCookiesOnly:r}=zt.loadOptions.value;let o,a=i?.cookie,l=!1;if(t){l=t;const i=a.domain??s,u=w(i)&&!(e=>{const{topDomain:t}=mi(window.location.href);return t===e})(U(i))||r,c=bi(n??"rsaRequest",u);if(Ti(c)){o=ki(c);const t=Ei(window.location.href),n=Ei(c);t!==n&&(a={...a,samesite:"None",secure:!0}),!r&&u&&n!==U(i)&&(l=!1,e.warn(((e,t,n)=>`${e}:: The provided cookie domain (${t}) does not match the current webpage's domain (${n}). Hence, the cookies will be set client-side.`)(q,i,n)))}else l=!1}return{sscEnabled:l,cookieOptions:a,finalDataServiceUrl:o}},$i=e=>{const{storage:t}=zt.loadOptions.value;let n=t?.type;w(n)&&!(e=>"string"===typeof e&&ut.includes(e))(n)&&(e.warn(((e,t,n)=>`${e}:: The storage type "${t}" is not supported. Please choose one of the following supported types: "${ut}". The default type "${n}" will be used instead.`)(q,n,ct)),n=ct);let i=t?.encryption?.version;const s=i&&wt[i];var r,o;!T(i)&&T(s)?(e.warn((r=wt,o=Tt,`${q}:: The storage encryption version "${i}" is not supported. Please choose one of the following supported versions: "${Object.keys(r)}". The default version "${o}" will be used instead.`)),i=Tt):T(i)&&(i=Tt);const a=t?.migrate,l=a&&i===Tt;!0===a&&l!==a&&e.warn(((e,t,n)=>`${e}:: The storage data migration has been disabled because the configured storage encryption version (${t}) is not the latest (${n}). To enable storage data migration, please update the storage encryption version to the latest version.`)(q,i,Tt));const{sscEnabled:u,finalDataServiceUrl:c,cookieOptions:d}=Ri(e);_e((()=>{zt.storage.type.value=n,zt.storage.cookie.value=d,zt.serverCookies.isEnabledServerSideCookies.value=u,zt.serverCookies.dataServiceUrl.value=c,zt.storage.encryptionPluginName.value=wt[i],zt.storage.migrate.value=l}))},Ni=(e,t,n,i,s,r,o)=>{let a;if(r){if(!Ti(r))return o.error(`${q}:: The base URL "${r}" for ${e} is not valid.`),null;a=ki(r)}else if(a=n,"cdn"===zt.context.app.value.installType){const e=(()=>{const e=document.querySelector("script[data-rsa-write-key]");if(e&&e.dataset.rsaWriteKey===zt.lifecycle.writeKey.value)return e.src;const t=document.getElementsByTagName("script"),n=/(?:^|\/)rsa(\.min)?\.js$/;for(const i of t){const e=i.getAttribute("src");if(e&&n.test(e))return e}})();e&&(a=e.split("/").slice(0,-1).concat(t).join("/"))}return s&&(a=a.replace(new RegExp(`/v3/modern/${t}$`),`/${i}/modern/${t}`)),a};class Li{constructor(e,t,n){this.errorHandler=t,this.logger=n,this.httpClient=e,this.onError=this.onError.bind(this),this.processConfig=this.processConfig.bind(this)}attachEffects(){it((()=>{this.logger.setMinLogLevel(zt.lifecycle.logLevel.value)}))}init(){const{logLevel:e,configUrl:t,lockIntegrationsVersion:n,lockPluginsVersion:i,destSDKBaseURL:s,pluginsSDKBaseURL:r,integrations:o}=zt.loadOptions.value,a=((e,t,n,i)=>Ni("integrations",ft,Et,e,t,n,i))(Se,n,s,this.logger);if(S(a))return;let l;l=((e,t,n,i)=>Ni("plugins",yt,It,e,t,n,i))(Se,i,r,this.logger),null!==l&&(this.attachEffects(),zt.lifecycle.activeDataplaneUrl.value=ki(zt.lifecycle.dataPlaneUrl.value),$i(this.logger),(e=>{const{provider:t,consentManagerPluginName:n,initialized:i,enabled:s,consentsData:r}=Di(zt.loadOptions.value.consentManagement,e),o=zt.loadOptions.value.preConsent;let a=o?.storage?.strategy??Ai;var l,u;w(a)&&!["none","session","anonymousId"].includes(a)&&(a=Ai,e.warn((l=q,u=o?.storage?.strategy,`${l}:: The pre-consent storage strategy "${u}" is not supported. Please choose one of the following supported strategies: "none, session, anonymousId". The default strategy "none" will be used instead.`)));let c=o?.events?.delivery??wi;w(c)&&!["immediate","buffer"].includes(c)&&(c=wi,e.warn(((e,t,n)=>`${e}:: The pre-consent events delivery type "${t}" is not supported. Please choose one of the following supported types: "immediate, buffer". The default type "${n}" will be used instead.`)(q,o?.events?.delivery,wi))),_e((()=>{zt.consents.activeConsentManagerPluginName.value=n,zt.consents.initialized.value=i,zt.consents.enabled.value=s,zt.consents.data.value=r,zt.consents.provider.value=t,zt.consents.preConsent.value={enabled:!0===zt.loadOptions.value.preConsent?.enabled&&!1===i&&!0===s,storage:{strategy:a},events:{delivery:c}}}))})(this.logger),(e=>{if(zt.dataPlaneEvents.deliveryEnabled.value){const t="XhrQueue";let n=t;zt.loadOptions.value.useBeacon&&(zt.capabilities.isBeaconAvailable.value?n="BeaconQueue":(n=t,e.warn("ConfigManager:: The Beacon API is not supported by your browser. The events will be sent using XHR instead."))),_e((()=>{zt.dataPlaneEvents.eventsQueuePluginName.value=n}))}})(this.logger),_e((()=>{zt.lifecycle.integrationsCDNPath.value=a,zt.lifecycle.pluginsCDNPath.value=l,e&&(zt.lifecycle.logLevel.value=e),zt.lifecycle.sourceConfigUrl.value=((e,t,n,i,s)=>{const r=new URLSearchParams({p:"npm",v:Se,build:bt,writeKey:t,lockIntegrationsVersion:n.toString(),lockPluginsVersion:i.toString()});let o=St,a=r,l="/sourceConfig/",u="";if(Ti(e)){const t=new URL(e);ki(t.pathname).endsWith("/sourceConfig")||(t.pathname=`${ki(t.pathname)}/sourceConfig/`),t.pathname=t.pathname.replace(/\/{2,}/g,"/"),r.forEach(((e,n)=>{null===t.searchParams.get(n)&&t.searchParams.set(n,e)})),o=t.origin,l=t.pathname,a=t.searchParams,u=t.hash}else s.warn(((e,t)=>`${e}:: The provided source config URL "${t}" is invalid. Using the default source config URL instead.`)(q,e));return`${o}${l}?${a}${u}`})(t,zt.lifecycle.writeKey.value,n,i,this.logger),zt.metrics.metricsServiceUrl.value=`${zt.lifecycle.activeDataplaneUrl.value}/rsaMetrics`,zt.nativeDestinations.loadOnlyIntegrations.value=o})),this.getConfig())}onError(e,t){this.errorHandler.onError(e,q,t)}processConfig(e,t){if(!w(e))return void(w(t)?this.onError(t.error,gt):this.onError(new Error(gt)));let n;try{n=I(e)?JSON.parse(e):e}catch(s){return void this.onError(s,dt)}if(!(e=>O(e)&&O(e.source)&&!A(e.source.id)&&O(e.source.config)&&Array.isArray(e.source.destinations))(n))return void this.onError(new Error(dt));if(!1===n.source.enabled)return void this.logger.error("The source is disabled. Please enable the source in the dashboard to send events.");Oi(n);const i=n.source.destinations.length>0?(e=>{const t=[];return e.forEach((e=>{e.enabled&&!e.deleted&&t.push({id:e.id,displayName:e.destinationDefinition.displayName,config:e.config,shouldApplyDeviceModeTransformation:e.shouldApplyDeviceModeTransformation||!1,propagateEventsUntransformedOnError:e.propagateEventsUntransformedOnError||!1,userFriendlyId:`${e.destinationDefinition.displayName.replaceAll(" ","-")}___${e.id}`})})),t})(n.source.destinations):[];_e((()=>{zt.source.value={config:n.source.config,name:n.source.name,id:n.source.id,workspaceId:n.source.workspaceId},zt.nativeDestinations.configuredDestinations.value=i,zt.plugins.pluginsToLoadFromConfig.value=zt.loadOptions.value.plugins??[],(e=>{let t,n=zt.consents.resolutionStrategy.value;O(e.consentManagementMetadata)&&(zt.consents.provider.value&&(n=e.consentManagementMetadata.providers.find((e=>e.provider===zt.consents.provider.value))?.resolutionStrategy??zt.consents.resolutionStrategy.value),t=e.consentManagementMetadata),"custom"===zt.consents.provider.value&&(n=void 0),_e((()=>{zt.consents.metadata.value=p(t),zt.consents.resolutionStrategy.value=n}))})(n),zt.lifecycle.status.value="configured"}))}getConfig(){const e=zt.loadOptions.value.getSourceConfig;if(e){if(!E(e))return void this.logger.error((t=q,`${t}:: The "getSourceConfig" load API option must be a function that returns valid source configuration data.`));const n=e();n instanceof Promise?n.then((e=>this.processConfig(e))).catch((e=>{this.onError(e,"SourceConfig")})):this.processConfig(n)}else this.httpClient.getAsyncData({url:zt.lifecycle.sourceConfigUrl.value,options:{headers:{"Content-Type":void 0}},callback:this.processConfig});var t}}const Mi=()=>document?.referrer||"$direct",Bi=()=>{const e=(()=>{const e=document.getElementsByTagName("link");let t="";for(let n=0;e[n];n+=1){const i=e[n];if("canonical"===i.getAttribute("rel")&&!t){t=i.getAttribute("href")??"";break}}return t})();let t=globalThis.location.pathname;const{href:n}=globalThis.location;let i=n;const{search:s}=globalThis.location;if(e)try{const n=new URL(e);i=""===n.search?e+s:e,t=n.pathname}catch(l){}const r=(e=>{let t=e;try{const n=new URL(e);t=n.origin+n.pathname+n.search}catch(n){}return t})(i),{title:o}=document,a=Mi();return{path:t,referrer:a,referring_domain:Ii(a),search:s,title:o,url:r,tab_url:n}},xi=`https://polyfill-fastly.io/v3/polyfill.min.js?version=3.111.0&features=${Object.keys(ai).join("%2C")}`,Ui="rudderstackPolyfill";class ji{constructor(e,t,n){this.httpClient=e,this.errorHandler=t,this.logger=n,this.externalSrcLoader=new xe(this.errorHandler,this.logger),this.onError=this.onError.bind(this),this.onReady=this.onReady.bind(this)}init(){this.prepareBrowserCapabilities(),this.attachWindowListeners()}detectBrowserCapabilities(){_e((()=>{zt.capabilities.storage.isCookieStorageAvailable.value=ci(Bn,pi(Bn),this.logger),zt.capabilities.storage.isLocalStorageAvailable.value=ci(xn,void 0,this.logger),zt.capabilities.storage.isSessionStorageAvailable.value=ci(Un,void 0,this.logger),zt.capabilities.isBeaconAvailable.value=!A(globalThis.navigator.sendBeacon)&&E(globalThis.navigator.sendBeacon),zt.capabilities.isUaCHAvailable.value=oi(),zt.capabilities.isCryptoAvailable.value=!A(globalThis.crypto)&&E(globalThis.crypto.getRandomValues),zt.capabilities.isIE11.value=Boolean(globalThis.navigator.userAgent.match(/Trident.*rv:11\./)),zt.capabilities.isOnline.value=globalThis.navigator.onLine,zt.context.userAgent.value=(()=>{if(T(globalThis.navigator))return null;let{userAgent:e}=globalThis.navigator;const{brave:t}=globalThis.navigator;if(t&&Object.getPrototypeOf(t).isBrave){const t=e.match(/(chrome)\/([\w.]+)/i);t&&(e=`${e} Brave/${t[2]}`)}return e})(),zt.context.locale.value=T(globalThis.navigator)?null:globalThis.navigator.language??globalThis.navigator.browserLanguage,zt.context.screen.value=li(),zt.context.timezone.value=(()=>{const e=/([A-Z]+[+-]\d+)/.exec((new Date).toString());return e?.[1]?e[1]:"NA"})(),oi()&&((e,t="none")=>{"none"===t&&e(void 0),"default"===t&&e(navigator.userAgentData),"full"===t&&navigator.userAgentData?.getHighEntropyValues(["architecture","bitness","brands","mobile","model","platform","platformVersion","uaFullVersion","fullVersionList","wow64"]).then((t=>{e(t)})).catch((()=>{e()}))})((e=>{zt.context["ua-ch"].value=e}),zt.loadOptions.value.uaChTrackLevel)})),it((()=>{!0===zt.loadOptions.value.sendAdblockPage&&void 0!==zt.lifecycle.sourceConfigUrl.value&&(e=>{const t=new URL(zt.lifecycle.sourceConfigUrl.value),n=`${t.origin}${t.pathname}?view=ad`;e.getAsyncData({url:n,options:{method:"HEAD",headers:{"Content-Type":void 0}},isRawResponse:!0,callback:(e,t)=>{zt.capabilities.isAdBlocked.value=void 0!==t?.error||t?.xhr?.responseURL!==n}})})(this.httpClient)}))}prepareBrowserCapabilities(){zt.capabilities.isLegacyDOM.value=(()=>{const e=Object.keys(ai);let t=!1;for(let n=0;n<e.length;n++){const i=ai[e[n]];if(E(i)&&i()){t=!0;break}}return t})();const e=zt.loadOptions.value.polyfillURL;let t=xi;C(e)&&(Ti(e)?t=e:this.logger.warn(((e,t)=>`${e}:: The provided polyfill URL "${t}" is invalid. The default polyfill URL will be used instead.`)(V,e)));if(zt.loadOptions.value.polyfillIfRequired&&zt.capabilities.isLegacyDOM.value&&Ti(t)){const e=t!==zt.loadOptions.value.polyfillURL;if(e){const e=`RS_polyfillCallback_${zt.lifecycle.writeKey.value}`,n=()=>{this.onReady(),delete globalThis[e]};globalThis[e]=n,t=`${t}&callback=${e}`}this.externalSrcLoader.loadJSFile({url:t,id:Ui,async:!0,timeout:1e4,callback:n=>{n?e||this.onReady():this.onError(new Error(((e,t)=>`Failed to load the polyfill script with ID "${e}" from URL ${t}.`)(Ui,t)))}})}else this.onReady()}attachWindowListeners(){globalThis.addEventListener("offline",(()=>{zt.capabilities.isOnline.value=!1})),globalThis.addEventListener("online",(()=>{zt.capabilities.isOnline.value=!0})),globalThis.addEventListener("resize",function(e,t,n=250){let i;return(...s)=>{globalThis.clearTimeout(i),i=globalThis.setTimeout((()=>{e.apply(t,s)}),n)}}((()=>{zt.context.screen.value=li()}),this))}onReady(){this.detectBrowserCapabilities(),zt.lifecycle.status.value="browserCapabilitiesReady"}onError(e){this.errorHandler.onError(e,V)}}const _i=["integrations","anonymousId","originalTimestamp"],Hi=["library","consentManagement","userAgent","ua-ch","screen"],Fi=["id","anonymous_id","user_id","sent_at","timestamp","received_at","original_timestamp","event","event_text","channel","context_ip","context_request_ip","context_passed_ip","group_id","previous_id"],Ki=e=>"number"===typeof e&&!Number.isNaN(e),Gi=e=>Ki(e)&&e>=0&&Number.isInteger(e),Qi=e=>{const t=Date.now();return Boolean(!e||t>e)},zi=(e,t)=>{const n=((e,t)=>{return!!(e&&Gi(e)&&(n=10,i=e,i.toString().length>=n))||(t.warn(((e,t,n)=>`${e}:: The provided session ID (${t}) is either invalid, not a positive integer, or not at least "${10}" digits long. A new session ID will be auto-generated instead.`)(X,e)),!1);var n,i})(e,t)?e:Date.now();return{id:n,sessionStart:void 0,manualTrack:!0}},Vi=e=>Boolean(e===Bn||e===xn||e===Un||e===jn),qi=()=>ue(),Wi=e=>{const t=Bi(),n={};return Object.keys(t).forEach((i=>{n[i]=e?.[i]||t[i]})),n.initial_referrer=e?.initial_referrer||zt.session.initialReferrer.value,n.initial_referring_domain=e?.initial_referring_domain||zt.session.initialReferringDomain.value,n},Ji=(e,t,n)=>{O(e)&&Object.keys(e).forEach((e=>{(Fi.includes(e)||Fi.includes(e.toLowerCase()))&&n.warn(((e,t,n,i)=>`${e}:: The "${t}" property defined under "${n}" is a reserved keyword. Please choose a different property name to avoid conflicts with reserved keywords (${i}).`)(W,e,t,Fi))}))},Xi=(e,t,n)=>{O(t)&&(((e,t)=>{t.anonymousId&&I(t.anonymousId)&&(e.anonymousId=t.anonymousId),N(t.integrations)&&(e.integrations=t.integrations),t.originalTimestamp&&I(t.originalTimestamp)&&(e.originalTimestamp=t.originalTimestamp)})(e,t),e.context=((e,t,n)=>{let i=e;return Object.keys(t).forEach((e=>{if(!_i.includes(e)&&!Hi.includes(e))if("context"!==e)i=$(i,{[e]:t[e]});else if(!T(t[e])&&O(t[e])){const n={};Object.keys(t[e]).forEach((i=>{Hi.includes(i)||(n[i]=t[e][i])})),i=$(i,{...n})}else n.warn('EventManager:: Please make sure that the "context" property in the event API\'s "options" argument is a valid object literal with key-value pairs.')})),i})(e.context,t,n))},Zi=(e,t,n,i)=>{const s={channel:"web",context:{traits:p(zt.session.userTraits.value),sessionId:zt.session.sessionInfo.value.id||void 0,sessionStart:zt.session.sessionInfo.value.sessionStart||void 0,...zt.consents.enabled.value&&{consentManagement:{deniedConsentIds:p(zt.consents.data.value.deniedConsentIds),allowedConsentIds:p(zt.consents.data.value.allowedConsentIds),provider:zt.consents.provider.value,resolutionStrategy:zt.consents.resolutionStrategy.value}},"ua-ch":zt.context["ua-ch"].value,app:zt.context.app.value,library:zt.context.library.value,userAgent:zt.context.userAgent.value,os:zt.context.os.value,locale:zt.context.locale.value,screen:zt.context.screen.value,campaign:Si(globalThis.location.href),page:Wi(n),timezone:zt.context.timezone.value,...zt.autoTrack.enabled.value&&{autoTrack:{...zt.autoTrack.pageLifecycle.enabled.value&&{page:{visitId:zt.autoTrack.pageLifecycle.visitId.value}}}}},originalTimestamp:ce(new Date),messageId:ue(),userId:e.userId||zt.session.userId.value};Vi(zt.storage.entries.value.anonymousId?.type)?s.anonymousId=zt.session.anonymousId.value:s.anonymousId=qi(),zt.storage.trulyAnonymousTracking.value&&(s.context.trulyAnonymousTracking=!0),"identify"===e.type&&(s.context.traits=zt.storage.entries.value.userTraits?.type!==_n?p(zt.session.userTraits.value):e.context.traits),"group"===e.type&&((e.groupId||zt.session.groupId.value)&&(s.groupId=e.groupId||zt.session.groupId.value),(e.traits||zt.session.groupTraits.value)&&(s.traits=zt.storage.entries.value.groupTraits?.type!==_n?p(zt.session.groupTraits.value):e.traits));const r=$(e,s);return void 0===r.event&&(r.event=null),void 0===r.properties&&(r.properties=null),Xi(r,t,i),((e,t)=>{const{properties:n,traits:i,context:s}=e,{traits:r}=s;Ji(n,"properties",t),Ji(i,"traits",t),Ji(r,"context.traits",t)})(r,i),r.integrations=(e=>{let t;return t=zt.loadOptions.value.useGlobalIntegrationsConfigInEvents?zt.consents.postConsent.value.integrations??zt.nativeDestinations.loadOnlyIntegrations.value:e||vt,p(t)})(r.integrations),r};class Yi{constructor(e){this.logger=e}generatePageEvent(e,t,n,i){let s=n??{};s=((e,t)=>{const n=t?.page||{},i=e,s=Bi();return Object.keys(s).forEach((e=>{T(i[e])&&(i[e]=n[e]||s[e])})),T(i.initial_referrer)&&(i.initial_referrer=n.initial_referrer||zt.session.initialReferrer.value),T(i.initial_referring_domain)&&(i.initial_referring_domain=n.initial_referring_domain||zt.session.initialReferringDomain.value),i})(s,i);return Zi({properties:s,name:t,category:e,type:"page"},i,s,this.logger)}generateTrackEvent(e,t,n){return Zi({properties:t,event:e,type:"track"},n,void 0,this.logger)}generateIdentifyEvent(e,t,n){return Zi({userId:e,type:"identify",context:{traits:t}},n,void 0,this.logger)}generateAliasEvent(e,t,n){const i=Zi({previousId:t,type:"alias"},n,void 0,this.logger);return i.userId=e??i.userId,i}generateGroupEvent(e,t,n){const i={type:"group"};return e&&(i.groupId=e),t&&(i.traits=t),Zi(i,n,void 0,this.logger)}create(e){let t;switch(e.type){case"page":t=this.generatePageEvent(e.category,e.name,e.properties,e.options);break;case"track":t=this.generateTrackEvent(e.name,e.properties,e.options);break;case"identify":t=this.generateIdentifyEvent(e.userId,e.traits,e.options);break;case"alias":t=this.generateAliasEvent(e.to,e.from,e.options);break;default:t=this.generateGroupEvent(e.groupId,e.traits,e.options)}return t}}class es{constructor(e,t,n,i){this.eventRepository=e,this.userSessionManager=t,this.errorHandler=n,this.logger=i,this.eventFactory=new Yi(this.logger)}init(){this.eventRepository.init()}resume(){this.eventRepository.resume()}addEvent(e){this.userSessionManager.refreshSession();const t=this.eventFactory.create(e);this.eventRepository.enqueue(t,e.callback)}}class ts{constructor(e,t,n,i,s){this.storeManager=t,this.pluginsManager=e,this.logger=s,this.errorHandler=i,this.httpClient=n,this.onError=this.onError.bind(this),this.serverSideCookieDebounceFuncs={}}init(){this.syncStorageDataToState(),this.registerEffects()}syncStorageDataToState(){this.migrateStorageIfNeeded(),this.migrateDataFromPreviousStorage(),this.setUserId(this.getUserId()),this.setUserTraits(this.getUserTraits()),this.setGroupId(this.getGroupId()),this.setGroupTraits(this.getGroupTraits());const{externalAnonymousIdCookieName:e,anonymousIdOptions:t}=zt.loadOptions.value;let n;C(e)&&"string"===typeof e&&(n=this.getExternalAnonymousIdByCookieName(e)),this.setAnonymousId(n??this.getAnonymousId(t)),this.setAuthToken(this.getAuthToken()),this.setInitialReferrerInfo(),this.configureSessionTracking()}configureSessionTracking(){let e=this.getSessionInfo();if(this.isPersistenceEnabledForStorageEntry("sessionInfo")){const t=this.getConfiguredSessionTrackingInfo(),n=e??Ot;e={...n,...t,autoTrack:t.autoTrack&&!0!==n.manualTrack},e.autoTrack||!0===e.manualTrack||(e=Dt.sessionInfo)}else e=Dt.sessionInfo;zt.session.sessionInfo.value=e,zt.session.sessionInfo.value.autoTrack&&this.startOrRenewAutoTracking(zt.session.sessionInfo.value)}setInitialReferrerInfo(){const e=this.getInitialReferrer(),t=this.getInitialReferringDomain();if(e&&t)this.setInitialReferrer(e),this.setInitialReferringDomain(t);else{const t=e||Mi();this.setInitialReferrer(t),this.setInitialReferringDomain(Ii(t))}}isPersistenceEnabledForStorageEntry(e){return Vi(zt.storage.entries.value[e]?.type)}migrateDataFromPreviousStorage(){const e=zt.storage.entries.value,t=[Bn,xn,Un];Object.keys(e).forEach((n=>{const i=n,s=e[i]?.type,r=this.storeManager?.getStore(zn[s]);r&&t.forEach((e=>{const t=this.storeManager?.getStore(zn[e]);if(t&&e!==s){const e=t.get(Hn[i]);(e=>C(e)&&""!==e)(e)&&r.set(Hn[i],e),t.remove(Hn[i])}}))}))}migrateStorageIfNeeded(){if(!zt.storage.migrate.value)return;const e=[];[Fn,Kn,Gn].forEach((t=>{const n=this.storeManager?.getStore(t);n&&e.push(n)})),Object.keys(Hn).forEach((t=>{const n=Hn[t];e.forEach((e=>{const t=this.pluginsManager?.invokeSingle("storage.migrate",n,e.engine,this.errorHandler,this.logger);A(t)||e.set(n,t)}))}))}getConfiguredSessionTrackingInfo(){let e,t=!1!==zt.loadOptions.value.sessions?.autoTrack;if(!t)return{autoTrack:t};const n=zt.loadOptions.value.sessions?.timeout;return Gi(n)?e=n:(this.logger.warn(((e,t,n)=>`${e}:: The session timeout value "${t}" is not a number. The default timeout of ${n} ms will be used instead.`)(X,n,De)),e=De),0===e&&(this.logger.warn(`${X}:: The session timeout value is 0, which disables the automatic session tracking feature. If you want to enable session tracking, please provide a positive integer value for the timeout.`),t=!1),e>0&&e<1e4&&this.logger.warn(((e,t,n)=>`${e}:: The session timeout value ${t} ms is less than the recommended minimum of ${n} ms. Please consider increasing the timeout value to ensure optimal performance and reliability.`)(X,e,1e4)),{timeout:e,autoTrack:t}}onError(e,t){this.errorHandler.onError(e,X,t)}getEncryptedCookieData(e,t){const n=[];return e.forEach((e=>{const i=t?.encrypt(pe(e.value,!1,[],this.logger));C(i)&&n.push({name:e.name,value:i})})),n}makeRequestToSetCookie(e,t){this.httpClient?.getAsyncData({url:zt.serverCookies.dataServiceUrl.value,options:{method:"POST",data:pe({reqType:"setCookies",workspaceId:zt.source.value?.workspaceId,data:{options:{maxAge:zt.storage.cookie.value?.maxage,path:zt.storage.cookie.value?.path,domain:zt.storage.cookie.value?.domain,sameSite:zt.storage.cookie.value?.samesite,secure:zt.storage.cookie.value?.secure,expires:zt.storage.cookie.value?.expires},cookies:e}}),sendRawData:!0,withCredentials:!0},isRawResponse:!0,callback:t})}setServerSideCookies(e,t,n){try{const i=this.getEncryptedCookieData(e,n);i.length>0&&this.makeRequestToSetCookie(i,((i,s)=>{var r;200===s?.xhr?.status?e.forEach((e=>{const i=n?.get(e.name),s=pe(e.value,!1,[]);pe(i,!1,[])!==s&&(this.logger.error(`The server failed to set the ${e.name} cookie. As a fallback, the cookies will be set client side.`),t&&t(e.name,e.value))})):(this.logger.error((r=s?.xhr?.status,`The server responded with status ${r} while setting the cookies. As a fallback, the cookies will be set client side.`)),e.forEach((e=>{t&&t(e.name,e.value)})))}))}catch(ze){this.onError(ze,"Failed to set/remove cookies via server. As a fallback, the cookies will be managed client side."),e.forEach((e=>{t&&t(e.name,e.value)}))}}syncValueToStorage(e,t){const n=zt.storage.entries.value,i=n[e]?.type;if(Vi(i)){const s=this.storeManager?.getStore(zn[i]),r=n[e]?.key;t&&(I(t)||N(t))?zt.serverCookies.isEnabledServerSideCookies.value&&i===Bn?(this.serverSideCookieDebounceFuncs[e]&&globalThis.clearTimeout(this.serverSideCookieDebounceFuncs[e]),this.serverSideCookieDebounceFuncs[e]=globalThis.setTimeout((()=>{this.setServerSideCookies([{name:r,value:t}],((e,t)=>{s?.set(e,t)}),s)}),10)):s?.set(r,t):s?.remove(r)}}registerEffects(){Qn.forEach((e=>{it((()=>{this.syncValueToStorage(e,zt.session[e].value)}))}))}setAnonymousId(e,t){let n=e;if(I(e)&&n||(n=void 0),this.isPersistenceEnabledForStorageEntry("anonymousId")){if(!n&&t){const e=this.pluginsManager?.invokeSingle("userSession.anonymousIdGoogleLinker",t);n=e}n=n||qi()}else n=Dt.anonymousId;zt.session.anonymousId.value=n}getAnonymousId(e){const t=zt.storage.entries.value.anonymousId?.type;if(Vi(t)){let t=this.getEntryValue("anonymousId");if(!t&&e){const n=this.pluginsManager?.invokeSingle("storage.getAnonymousId",pi,e);t=n}zt.session.anonymousId.value=t||qi()}return zt.session.anonymousId.value}getEntryValue(e){const t=zt.storage.entries.value,n=t[e]?.type;if(Vi(n)){const i=this.storeManager?.getStore(zn[n]),s=t[e]?.key;return i?.get(s)??null}return null}getExternalAnonymousIdByCookieName(e){const t=pi(Bn);return t?.isEnabled?t.getItem(e)??null:null}getUserId(){return this.getEntryValue("userId")}getUserTraits(){return this.getEntryValue("userTraits")}getGroupId(){return this.getEntryValue("groupId")}getGroupTraits(){return this.getEntryValue("groupTraits")}getInitialReferrer(){return this.getEntryValue("initialReferrer")}getInitialReferringDomain(){return this.getEntryValue("initialReferringDomain")}getSessionInfo(){return this.getEntryValue("sessionInfo")}getAuthToken(){return this.getEntryValue("authToken")}getSessionId(){const e=this.getSessionInfo()??Dt.sessionInfo;return e.autoTrack&&!Qi(e.expiresAt)||e.manualTrack?e.id??null:null}refreshSession(){let e=this.getSessionInfo()??Dt.sessionInfo;(e.autoTrack||e.manualTrack)&&(e.autoTrack&&(this.startOrRenewAutoTracking(e),e=zt.session.sessionInfo.value),void 0===e.sessionStart?e={...e,sessionStart:!0}:e.sessionStart&&(e={...e,sessionStart:!1})),zt.session.sessionInfo.value=e,"readyExecuted"!==zt.lifecycle.status.value&&this.syncValueToStorage("sessionInfo",e)}reset(e,t){const{session:n}=zt,{manualTrack:i,autoTrack:s}=n.sessionInfo.value;_e((()=>{n.userId.value=Dt.userId,n.userTraits.value=Dt.userTraits,n.groupId.value=Dt.groupId,n.groupTraits.value=Dt.groupTraits,n.authToken.value=Dt.authToken,!0===e&&this.setAnonymousId(),t||(s?(n.sessionInfo.value=Dt.sessionInfo,this.startOrRenewAutoTracking(n.sessionInfo.value)):i&&this.startManualTrackingInternal())}))}setUserId(e){zt.session.userId.value=this.isPersistenceEnabledForStorageEntry("userId")&&e?e:Dt.userId}setUserTraits(e){zt.session.userTraits.value=this.isPersistenceEnabledForStorageEntry("userTraits")&&O(e)?$(zt.session.userTraits.value??Dt.userTraits,e):Dt.userTraits}setGroupId(e){zt.session.groupId.value=this.isPersistenceEnabledForStorageEntry("groupId")&&e?e:Dt.groupId}setGroupTraits(e){zt.session.groupTraits.value=this.isPersistenceEnabledForStorageEntry("groupTraits")&&O(e)?$(zt.session.groupTraits.value??Dt.groupTraits,e):Dt.groupTraits}setInitialReferrer(e){zt.session.initialReferrer.value=this.isPersistenceEnabledForStorageEntry("initialReferrer")&&e?e:Dt.initialReferrer}setInitialReferringDomain(e){zt.session.initialReferringDomain.value=this.isPersistenceEnabledForStorageEntry("initialReferringDomain")&&e?e:Dt.initialReferringDomain}startOrRenewAutoTracking(e){if(Qi(e.expiresAt))zt.session.sessionInfo.value=(e=>{const t=Date.now(),n=e||De;return{id:t,expiresAt:t+n,timeout:n,sessionStart:void 0,autoTrack:!0}})(e.timeout);else{const t=Date.now(),n=e.timeout;zt.session.sessionInfo.value=$(e,{expiresAt:t+n})}}start(e){zt.session.sessionInfo.value=zi(e,this.logger)}startManualTrackingInternal(){this.start(Date.now())}end(){zt.session.sessionInfo.value=Dt.sessionInfo}setAuthToken(e){zt.session.authToken.value=this.isPersistenceEnabledForStorageEntry("authToken")&&e?e:Dt.authToken}}const ns=["BeaconQueue","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ExternalAnonymousId","GoogleLinker","IubendaConsentManager","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],is=(e,t)=>{const n=p(e),i=t.nativeDestinations.integrationsConfig.value,s=((e,t)=>Object.keys(e).filter((n=>!0!==e[n]||!t[n])).reduce(((t,n)=>{const i=p(t);return i[n]=e[n],i}),{}))(e.integrations,i);return n.integrations=$(i,s),n},ss=(e,t,n,i)=>{if(w(e))if(E(e))try{e(...t)}catch(s){i.error(`${n}:: The callback threw an exception`,s)}else i.error(ht(n))};class rs{constructor(e,t,n,i,s){this.pluginsManager=e,this.errorHandler=i,this.httpClient=n,this.logger=s,this.storeManager=t}init(){this.dataplaneEventsQueue=this.pluginsManager.invokeSingle("dataplaneEventsQueue.init",zt,this.httpClient,this.storeManager,this.errorHandler,this.logger),this.dmtEventsQueue=this.pluginsManager.invokeSingle("transformEvent.init",zt,this.pluginsManager,this.httpClient,this.storeManager,this.errorHandler,this.logger),this.destinationsEventsQueue=this.pluginsManager.invokeSingle("destinationsEventsQueue.init",zt,this.pluginsManager,this.storeManager,this.dmtEventsQueue,this.errorHandler,this.logger),it((()=>{!0===zt.nativeDestinations.clientDestinationsReady.value&&(this.destinationsEventsQueue?.start(),this.dmtEventsQueue?.start())}));const e=(e=>e.consents.preConsent.value.enabled&&"buffer"===e.consents.preConsent.value.events?.delivery&&("session"===e.consents.preConsent.value.storage?.strategy||"none"===e.consents.preConsent.value.storage?.strategy))(zt);let t;it((()=>{const n=!0===zt.loadOptions.value.bufferDataPlaneEventsUntilReady&&!1===zt.nativeDestinations.clientDestinationsReady.value;!1!==zt.nativeDestinations.activeDestinations.value.some((e=>{return t=e,Boolean("hybrid"===t.config.connectionMode||!0===t.config.useNativeSDKToSend);var t}))&&!1!==n||e||!0===this.dataplaneEventsQueue?.scheduleTimeoutActive||(globalThis.clearTimeout(t),this.dataplaneEventsQueue?.start())})),!0===zt.loadOptions.value.bufferDataPlaneEventsUntilReady&&(t=globalThis.setTimeout((()=>{!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&this.dataplaneEventsQueue?.start()}),zt.loadOptions.value.dataPlaneEventsBufferTimeout))}resume(){!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&(zt.consents.postConsent.value.discardPreConsentEvents&&(this.dataplaneEventsQueue?.clear(),this.destinationsEventsQueue?.clear()),this.dataplaneEventsQueue?.start())}enqueue(e,t){const n=is(e,zt);this.pluginsManager.invokeSingle("dataplaneEventsQueue.enqueue",zt,this.dataplaneEventsQueue,n,this.errorHandler,this.logger);const i=p(e);this.pluginsManager.invokeSingle("destinationsEventsQueue.enqueue",zt,this.destinationsEventsQueue,i,this.errorHandler,this.logger);const s=`${e.type.charAt(0).toUpperCase()}${e.type.slice(1)}API`;ss(t,[n],s,this.logger)}}const os=e=>{const t=new CustomEvent(e,{detail:{analyticsInstance:globalThis.rudderanalytics},bubbles:!0,cancelable:!0,composed:!0});globalThis.document.dispatchEvent(t)};class as{constructor(){this.preloadBuffer=new st,this.initialized=!1,this.errorHandler=En,this.logger=at,this.externalSrcLoader=new xe(this.errorHandler,this.logger),this.httpClient=hn,this.httpClient.init(this.errorHandler),this.capabilitiesManager=new ji(this.httpClient,this.errorHandler,this.logger)}load(e,t,n={}){zt.lifecycle.status.value||((e=>I(e)&&e.trim().length>0)(e)?(e=>Ti(e))(t)?(_e((()=>{zt.lifecycle.writeKey.value=p(e),zt.lifecycle.dataPlaneUrl.value=p(t),zt.loadOptions.value=((e,t)=>{const n=p(t);return I(n.setCookieDomain)||(n.setCookieDomain=void 0),["Strict","Lax","None"].includes(n.sameSiteCookie)||(n.sameSiteCookie=void 0),n.secureCookie=x(n.secureCookie,e.secureCookie),n.sameDomainCookiesOnly=x(n.sameDomainCookiesOnly,e.sameDomainCookiesOnly),["none","default","full"].includes(n.uaChTrackLevel)||(n.uaChTrackLevel=void 0),n.integrations=B(n.integrations),Array.isArray(n.plugins)||(n.plugins=ns),n.useGlobalIntegrationsConfigInEvents=x(n.useGlobalIntegrationsConfigInEvents,e.useGlobalIntegrationsConfigInEvents),n.bufferDataPlaneEventsUntilReady=x(n.bufferDataPlaneEventsUntilReady,e.bufferDataPlaneEventsUntilReady),n.sendAdblockPage=x(n.sendAdblockPage,e.sendAdblockPage),n.useServerSideCookies=x(n.useServerSideCookies,e.useServerSideCookies),I(n.dataServiceEndpoint)||(n.dataServiceEndpoint=void 0),n.sendAdblockPageOptions=B(n.sendAdblockPageOptions),n.loadIntegration=x(n.loadIntegration,e.loadIntegration),N(n.storage)?(n.storage.migrate=x(n.storage.migrate,e.storage?.migrate),n.storage.cookie=B(n.storage.cookie),n.storage.encryption=B(n.storage.encryption),n.storage=M(n.storage)):n.storage=void 0,n.destinationsQueueOptions=B(n.destinationsQueueOptions),n.queueOptions=B(n.queueOptions),n.lockIntegrationsVersion=x(n.lockIntegrationsVersion,e.lockIntegrationsVersion),n.lockPluginsVersion=x(n.lockPluginsVersion,e.lockPluginsVersion),Ki(n.dataPlaneEventsBufferTimeout)||(n.dataPlaneEventsBufferTimeout=void 0),n.beaconQueueOptions=B(n.beaconQueueOptions),n.preConsent=B(n.preConsent),$(e,M(n))})(zt.loadOptions.value,n),zt.lifecycle.status.value="mounted"})),this.logger.setMinLogLevel(zt.loadOptions.value.logLevel??ot),Re("state",zt,e),this.startLifecycle()):this.logger.error(((e,t)=>`${e}:: The data plane URL "${t}" is invalid. It must be a valid URL string. Please check that the data plane URL is correct and try again.`)(te,t)):this.logger.error(((e,t)=>`${e}:: The write key "${t}" is invalid. It must be a non-empty string. Please check that the write key is correct and try again.`)(te,e)))}startLifecycle(){it((()=>{try{switch(zt.lifecycle.status.value){case"mounted":this.onMounted();break;case"browserCapabilitiesReady":this.onBrowserCapabilitiesReady();break;case"configured":this.onConfigured();break;case"pluginsLoading":case"destinationsLoading":case"readyExecuted":default:break;case"pluginsReady":this.onPluginsReady();break;case"initialized":this.onInitialized();break;case"loaded":this.onLoaded();break;case"destinationsReady":this.onDestinationsReady();break;case"ready":this.onReady()}}catch(e){const t="Failed to load the SDK";this.errorHandler.onError(ke(e,t),te)}}))}onBrowserCapabilitiesReady(){Le(this),this.prepareInternalServices(),this.loadConfig()}onLoaded(){this.processBufferedEvents(),!0===zt.consents.preConsent.value.enabled?zt.lifecycle.status.value="ready":this.loadDestinations()}onMounted(){this.capabilitiesManager.init()}enqueuePreloadBufferEvents(e){Array.isArray(e)&&e.forEach((e=>this.preloadBuffer.enqueue(p(e))))}processDataInPreloadBuffer(){for(;this.preloadBuffer.size()>0;){const e=this.preloadBuffer.dequeue();e&&Me([...e],this)}}prepareInternalServices(){this.pluginsManager=new Mn(In,this.errorHandler,this.logger),this.storeManager=new yi(this.pluginsManager,this.errorHandler,this.logger),this.configManager=new Li(this.httpClient,this.errorHandler,this.logger),this.userSessionManager=new ts(this.pluginsManager,this.storeManager,this.httpClient,this.errorHandler,this.logger),this.eventRepository=new rs(this.pluginsManager,this.storeManager,this.httpClient,this.errorHandler,this.logger),this.eventManager=new es(this.eventRepository,this.userSessionManager,this.errorHandler,this.logger)}loadConfig(){zt.lifecycle.writeKey.value&&this.httpClient.setAuthHeader(zt.lifecycle.writeKey.value),this.configManager?.init()}onPluginsReady(){this.storeManager?.init(),this.userSessionManager?.init(),zt.consents.enabled.value&&!zt.consents.initialized.value&&(this.pluginsManager?.invokeSingle("consentManager.init",zt,this.logger),!1===zt.consents.preConsent.value.enabled&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",zt,this.storeManager,this.logger)),this.eventManager?.init(),zt.lifecycle.status.value="initialized"}onConfigured(){this.pluginsManager?.init()}onInitialized(){this.processDataInPreloadBuffer();const e=zt.loadOptions.value.onLoaded;ss(e,[globalThis.rudderanalytics],"LoadAPI",this.logger),_e((()=>{zt.lifecycle.loaded.value=!0,zt.lifecycle.status.value="loaded"})),this.initialized=!0,os("RSA_Initialised")}onReady(){zt.lifecycle.status.value="readyExecuted",zt.eventBuffer.readyCallbacksArray.value.forEach((e=>{ss(e,[],ee,this.logger)})),os("RSA_Ready")}processBufferedEvents(){let e=zt.eventBuffer.toBeProcessedArray.value;for(;e.length>0;){const t=e.shift();if(zt.eventBuffer.toBeProcessedArray.value=e,t){const e=t[0];E(this[e])&&this[e](...t.slice(1),!0)}e=zt.eventBuffer.toBeProcessedArray.value}}loadDestinations(){if(zt.nativeDestinations.clientDestinationsReady.value)return;this.pluginsManager?.invokeSingle("nativeDestinations.setActiveDestinations",zt,this.pluginsManager,this.errorHandler,this.logger);const e=zt.nativeDestinations.activeDestinations.value.length;0!==e?(zt.lifecycle.status.value="destinationsLoading",this.pluginsManager?.invokeSingle("nativeDestinations.load",zt,this.externalSrcLoader,this.errorHandler,this.logger),it((()=>{(0===e||zt.nativeDestinations.initializedDestinations.value.length+zt.nativeDestinations.failedDestinations.value.length===e)&&_e((()=>{zt.lifecycle.status.value="destinationsReady",zt.nativeDestinations.clientDestinationsReady.value=!0}))}))):zt.lifecycle.status.value="destinationsReady"}onDestinationsReady(){"ready"!==zt.lifecycle.status.value&&(zt.lifecycle.status.value="ready")}ready(e,t=!1){const n="ready";zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb("New ready invocation"),E(e)?"readyExecuted"===zt.lifecycle.status.value?ss(e,[],ee,this.logger):zt.eventBuffer.readyCallbacksArray.value=[...zt.eventBuffer.readyCallbacksArray.value,e]:this.logger.error(ht(ee))):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[n,e]]}page(e,t=!1){const n="page";zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb("New page event"),zt.metrics.triggered.value+=1,this.eventManager?.addEvent({type:"page",category:e.category,name:e.name,properties:e.properties,options:e.options,callback:e.callback}),!0===zt.capabilities.isAdBlocked.value&&e.category!==Te&&this.page(H(Te,"ad-block page request",{path:"/ad-blocked"},zt.loadOptions.value.sendAdblockPageOptions))):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[n,e]]}track(e,t=!1){const n="track";zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New track event - ${e.name}`),zt.metrics.triggered.value+=1,this.eventManager?.addEvent({type:n,name:e.name||void 0,properties:e.properties,options:e.options,callback:e.callback})):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[n,e]]}identify(e,t=!1){const n="identify";if(!zt.lifecycle.loaded.value)return void(zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[n,e]]);this.errorHandler.leaveBreadcrumb(`New ${n} event`),zt.metrics.triggered.value+=1;Boolean(e.userId&&zt.session.userId.value&&e.userId!==zt.session.userId.value)&&this.reset(),S(e.userId)||this.userSessionManager?.setUserId(e.userId),this.userSessionManager?.setUserTraits(e.traits),this.eventManager?.addEvent({type:n,userId:e.userId,traits:e.traits,options:e.options,callback:e.callback})}alias(e,t=!1){const n="alias";if(!zt.lifecycle.loaded.value)return void(zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[n,e]]);this.errorHandler.leaveBreadcrumb("New alias event"),zt.metrics.triggered.value+=1;const i=e.from??this.userSessionManager?.getUserId()??this.userSessionManager?.getAnonymousId();this.eventManager?.addEvent({type:n,to:e.to,from:i,options:e.options,callback:e.callback})}group(e,t=!1){const n="group";zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb("New group event"),zt.metrics.triggered.value+=1,S(e.groupId)||this.userSessionManager?.setGroupId(e.groupId),this.userSessionManager?.setGroupTraits(e.traits),this.eventManager?.addEvent({type:n,groupId:e.groupId,traits:e.traits,options:e.options,callback:e.callback})):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[n,e]]}reset(e,t=!1){const n="reset";zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New reset invocation, resetAnonymousId: ${e}`),this.userSessionManager?.reset(e)):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[n,e]]}getAnonymousId(e){return this.userSessionManager?.getAnonymousId(e)}setAnonymousId(e,t,n=!1){const i="setAnonymousId";zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${i} invocation`),this.userSessionManager?.setAnonymousId(e,t)):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[i,e,t]]}getUserId(){return zt.session.userId.value}getUserTraits(){return zt.session.userTraits.value}getGroupId(){return zt.session.groupId.value}getGroupTraits(){return zt.session.groupTraits.value}startSession(e,t=!1){const n="startSession";zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),this.userSessionManager?.start(e)):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[n,e]]}endSession(e=!1){const t="endSession";zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${t} invocation`),this.userSessionManager?.end()):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,[t]]}getSessionId(){const e=this.userSessionManager?.getSessionId();return e??null}consent(e,t=!1){zt.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb("New consent invocation"),_e((()=>{zt.consents.preConsent.value={...zt.consents.preConsent.value,enabled:!1},zt.consents.postConsent.value=(e=>{const t={sendPageEvent:!1,trackConsent:!1,discardPreConsentEvents:!1};if(O(e)){const n=p(e);t.storage=n.storage,N(n.integrations)&&(t.integrations=n.integrations),t.discardPreConsentEvents=!0===n.discardPreConsentEvents,t.sendPageEvent=!0===n.sendPageEvent,t.trackConsent=!0===n.trackConsent,N(n.consentManagement)&&(t.consentManagement=$(n.consentManagement,{enabled:zt.consents.enabled.value}))}return t})(e);const{initialized:t,consentsData:n}=Di(zt.consents.postConsent.value.consentManagement,this.logger);zt.consents.initialized.value=t,zt.consents.data.value=n})),zt.consents.enabled.value&&!zt.consents.initialized.value&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",zt,this.storeManager,this.logger),this.storeManager?.initializeStorageState(),this.userSessionManager?.syncStorageDataToState(),this.eventManager?.resume(),this.loadDestinations(),this.sendTrackingEvents(t)):zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,["consent",e]]}sendTrackingEvents(e){if(zt.consents.postConsent.value.trackConsent){const t=F("Consent Management Interaction");e?zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,["track",t]]:this.track(t)}if(zt.consents.postConsent.value.sendPageEvent){const t=H();e?zt.eventBuffer.toBeProcessedArray.value=[...zt.eventBuffer.toBeProcessedArray.value,["page",t]]:this.page(t)}}setAuthToken(e){this.userSessionManager?.setAuthToken(e)}}class ls{static globalSingleton=null;analyticsInstances={};defaultAnalyticsKey="";logger=(()=>at)();constructor(){try{if(ls.globalSingleton)return ls.globalSingleton;ls.initializeGlobalResources(),this.setDefaultInstanceKey=this.setDefaultInstanceKey.bind(this),this.getAnalyticsInstance=this.getAnalyticsInstance.bind(this),this.load=this.load.bind(this),this.ready=this.ready.bind(this),this.triggerBufferedLoadEvent=this.triggerBufferedLoadEvent.bind(this),this.page=this.page.bind(this),this.track=this.track.bind(this),this.identify=this.identify.bind(this),this.alias=this.alias.bind(this),this.group=this.group.bind(this),this.reset=this.reset.bind(this),this.getAnonymousId=this.getAnonymousId.bind(this),this.setAnonymousId=this.setAnonymousId.bind(this),this.getUserId=this.getUserId.bind(this),this.getUserTraits=this.getUserTraits.bind(this),this.getGroupId=this.getGroupId.bind(this),this.getGroupTraits=this.getGroupTraits.bind(this),this.startSession=this.startSession.bind(this),this.endSession=this.endSession.bind(this),this.getSessionId=this.getSessionId.bind(this),this.setAuthToken=this.setAuthToken.bind(this),this.consent=this.consent.bind(this),ls.globalSingleton=this,zt.autoTrack.pageLifecycle.visitId.value=ue(),zt.autoTrack.pageLifecycle.pageLoadedTimestamp.value=Date.now(),this.triggerBufferedLoadEvent(),globalThis.rudderanalytics=this}catch(e){Ee(e)}}static initializeGlobalResources(){En.init(),hi.configure(),di.configure(),gi.configure(),ti.configure()}setDefaultInstanceKey(e){I(e)&&e&&(this.defaultAnalyticsKey=e)}getAnalyticsInstance(e){try{let t=e;I(t)&&t||(t=this.defaultAnalyticsKey);return Boolean(this.analyticsInstances[t])||(this.analyticsInstances[t]=new as),this.analyticsInstances[t]}catch(t){return void Ee(t)}}load(e,t,n){try{if(this.analyticsInstances[e])return;this.setDefaultInstanceKey(e);const i=$e(Ae);this.trackPageLifecycleEvents(i,n),(e=>{const t="consent",n=e.filter((e=>e[0]===t)),i=e.filter((e=>e[0]!==t));e.splice(0,e.length,...n,...i)})(i),Re(Ae,p(i)),this.getAnalyticsInstance(e)?.load(e,t,ye(n))}catch(i){Ee(i)}}trackPageLifecycleEvents(e,t){const{autoTrack:n,useBeacon:i}=t??{},{enabled:s=!1,options:r={},pageLifecycle:o}=n??{},{events:a=[z.LOADED,z.UNLOADED],enabled:l=s,options:u=r}=o??{};zt.autoTrack.pageLifecycle.enabled.value=l,zt.autoTrack.enabled.value=s||l,l&&(this.trackPageLoadedEvent(a,u,e),this.setupPageUnloadTracking(a,i,u))}trackPageLoadedEvent(e,t,n){(0===e.length||e.includes(z.LOADED))&&n.unshift(["track",z.LOADED,{},{...t,originalTimestamp:ce(new Date(zt.autoTrack.pageLifecycle.pageLoadedTimestamp.value))}])}setupPageUnloadTracking(e,t,n){(0===e.length||e.includes(z.UNLOADED))&&(!0===t?(e=>{let t=!1,n=!1;function i(){t||(t=!0,e(n),setTimeout((()=>{t=!1}),0))}globalThis.addEventListener("beforeunload",(()=>{n=!1,i()})),globalThis.addEventListener("blur",(()=>{n=!0,i()})),globalThis.addEventListener("focus",(()=>{t=!1})),document.addEventListener("pagehide",(()=>{n="hidden"===document.visibilityState,i()})),document.addEventListener("visibilitychange",(()=>{n=!0,"hidden"===document.visibilityState?i():t=!1}))})((e=>{if(!1===e&&zt.lifecycle.loaded.value){const e=Date.now(),t=e-zt.autoTrack.pageLifecycle.pageLoadedTimestamp.value;this.track(z.UNLOADED,{visitDuration:t},{...n,originalTimestamp:ce(new Date(e))})}})):this.logger.warn(`${"RudderStackAnalytics"}:: Page Unloaded event can only be tracked when the Beacon transport is active. Please enable "useBeacon" load API option.`))}triggerBufferedLoadEvent(){const e=Array.isArray(globalThis.rudderanalytics)?globalThis.rudderanalytics:[],t=(e=>{let t=[],n=0;for(;n<e.length;){if(e[n]&&"load"===e[n][0]){t=p(e[n]),e.splice(n,1);break}n+=1}return t})(e);Re(Ae,p([...e])),t.length>0&&(t.shift(),this.load.apply(null,t))}ready(e){try{this.getAnalyticsInstance()?.ready(ye(e))}catch(t){Ee(t)}}page(e,t,n,i,s){try{this.getAnalyticsInstance()?.page(H(ye(e),ye(t),ye(n),ye(i),ye(s)))}catch(r){Ee(r)}}track(e,t,n,i){try{this.getAnalyticsInstance()?.track(F(ye(e),ye(t),ye(n),ye(i)))}catch(s){Ee(s)}}identify(e,t,n,i){try{this.getAnalyticsInstance()?.identify(K(ye(e),ye(t),ye(n),ye(i)))}catch(s){Ee(s)}}alias(e,t,n,i){try{this.getAnalyticsInstance()?.alias(G(ye(e),ye(t),ye(n),ye(i)))}catch(s){Ee(s)}}group(e,t,n,i){try{this.getAnalyticsInstance()?.group(Q(ye(e),ye(t),ye(n),ye(i)))}catch(s){Ee(s)}}reset(e){try{this.getAnalyticsInstance()?.reset(ye(e))}catch(t){Ee(t)}}getAnonymousId(e){try{return this.getAnalyticsInstance()?.getAnonymousId(ye(e))}catch(t){return void Ee(t)}}setAnonymousId(e,t){try{this.getAnalyticsInstance()?.setAnonymousId(ye(e),ye(t))}catch(n){Ee(n)}}getUserId(){try{return this.getAnalyticsInstance()?.getUserId()}catch(e){return void Ee(e)}}getUserTraits(){try{return this.getAnalyticsInstance()?.getUserTraits()}catch(e){return void Ee(e)}}getGroupId(){try{return this.getAnalyticsInstance()?.getGroupId()}catch(e){return void Ee(e)}}getGroupTraits(){try{return this.getAnalyticsInstance()?.getGroupTraits()}catch(e){return void Ee(e)}}startSession(e){try{this.getAnalyticsInstance()?.startSession(ye(e))}catch(t){Ee(t)}}endSession(){try{this.getAnalyticsInstance()?.endSession()}catch(e){Ee(e)}}getSessionId(){try{return this.getAnalyticsInstance()?.getSessionId()}catch(e){return void Ee(e)}}setAuthToken(e){try{this.getAnalyticsInstance()?.setAuthToken(ye(e))}catch(t){Ee(t)}}consent(e){try{this.getAnalyticsInstance()?.consent(ye(e))}catch(t){Ee(t)}}}}}]);